<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Honoua â€” Comparateur</title>
  <style>
    :root{
      --green:#2e7d32; --orange:#F5C147; --blue:#001D85;
      --bg:#f7f7f8; --ink:#111; --muted:#70757a; --card:#fff; --line:#e6e6e9;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    header{
      position:sticky;top:0;z-index:5;background:var(--card);border-bottom:1px solid var(--line);
      display:flex;align-items:center;gap:12px;padding:10px 14px;height:60px;
    }
    .logo{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,#062909,var(--blue));}
    .titles{flex:1;min-width:0}
    .titles h1{margin:0;font-size:18px;line-height:1.1;font-weight:700;letter-spacing:.2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .titles p{margin:2px 0 0;font-size:12px;color:var(--muted)}
    main{padding:12px}
    .bar, .toolbar{
      display:flex;gap:8px;align-items:center;padding:10px;background:var(--card);
      border:1px solid var(--line);border-radius:14px;
    }
    .toolbar{margin-top:10px;flex-wrap:wrap}
    input[type="text"]{
      flex:1;border:1px solid var(--line);border-radius:10px;padding:10px 12px;font-size:14px;outline:none;background:#fff;
    }
    select{
      border:1px solid var(--line);border-radius:10px;padding:10px 12px;font-size:14px;background:#fff;min-width:180px;
    }
    label.switch{display:inline-flex;align-items:center;gap:8px;font-size:13px;color:var(--ink)}
    label.switch input{accent-color:var(--blue)}
    button{border:0;border-radius:12px;padding:10px 14px;font-weight:700;font-size:14px;cursor:pointer}
    .btn-primary{background:var(--blue);color:#fff}
    .btn-ghost{background:transparent;border:1px solid var(--line);color:var(--ink)}
    .btn-danger{background:#111;color:#fff;border:1px solid #000}
    .btn-muted{background:#e9eaee;color:#555;border:1px solid var(--line)}
    .help{font-size:12px;color:var(--muted);margin:8px 2px}
    .tracks{
      margin-top:12px;background:var(--card);border:1px solid var(--line);border-radius:14px;padding:10px;
      display:flex;gap:8px;overflow-x:auto;scroll-snap-type:x mandatory;
    }
    .card{
      min-width:220px;max-width:240px;background:#fff;border:1px solid var(--line);border-radius:16px;
      padding:12px;scroll-snap-align:start;box-shadow:0 1px 0 rgba(0,0,0,.04);position:relative;
    }
    .card h3{margin:6px 0 4px;font-size:14px}
    .meta{font-size:12px;color:var(--muted);margin-bottom:8px}
    .thumb{
      width:100%;height:120px;border-radius:12px;background:#f2f3f5;border:1px dashed var(--line);
      display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--muted);
    }
    .row{display:flex;gap:8px;margin-top:10px}
    .row button{flex:1}
    .empty{padding:16px;text-align:center;color:var(--muted);font-size:13px}
    /* Badge + jauge */
    .badge{
      display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:6px 8px;border-radius:999px;
      border:1px solid var(--line);background:#fafafa;margin-top:8px;
    }
    .badge .dot{width:10px;height:10px;border-radius:50%;background:var(--orange)}
    .rank{
      position:absolute;top:10px;left:10px;background:#111;color:#fff;border-radius:999px;
      font-size:12px;padding:4px 8px;line-height:1;display:none;
    }
    .rank.show{display:inline-block}
    .gauge{width:85%; height:10px; border-radius:999px; background:#eee; margin-top:8px; position:relative; overflow:hidden;border:1px solid var(--line)}
    .gauge > i{content:""; position:absolute; left:0; top:0; height:100%; width:0%; border-radius:999px;background: linear-gradient(90deg, var(--green), var(--orange)); transition: width .35s ease}
    .gauge-label{font-size:12px;color:var(--muted);margin-top:4px}
    /* Skeleton simple */
    .shimmer{background:linear-gradient(110deg,#eee 8%,#f5f5f7 18%,#eee 33%);background-size:200% 100%;animation:sh 1.2s linear infinite}
    @keyframes sh{to{background-position-x:-200%}}
  </style>
</head>
<body>
  <header>
    <div class="logo" aria-hidden="true"></div>
    <div class="titles">
      <h1>Comparateur carbone</h1>
      <p>A4â€“A6 â€” Tri, rang, partage, compteur, retirer tout</p>
    </div>
    <div style="width:40px"></div>
  </header>

  <main>
    <div class="bar" role="region" aria-label="Ajout de produits">
      <input id="eanInput" type="text" inputmode="numeric" placeholder="Ajouter un EAN (ex : 3017620422003)" aria-label="EAN Ã  ajouter" />
      <button id="addBtn" class="btn-primary" aria-label="Ajouter le produit">Ajouter</button>
      <button id="clearBtn" class="btn-ghost" title="RÃ©initialiser le champ">â†º</button>
    </div>

    <div class="toolbar" role="region" aria-label="Outils de comparaison">
      <select id="sortSelect" aria-label="Trier par">
        <option value="best">Trier : Meilleure empreinte dâ€™abord</option>
        <option value="worst">Trier : Pire empreinte dâ€™abord</option>
        <option value="brand">Trier : Marque (Aâ†’Z)</option>
        <option value="name">Trier : Nom (Aâ†’Z)</option>
        <option value="ean">Trier : EAN</option>
      </select>
      <label class="switch" title="Afficher le rang sur chaque carte">
        <input id="toggleRank" type="checkbox" /> Afficher le rang
      </label>
      <button id="importUrlBtn" class="btn-ghost" aria-label="Importer depuis lâ€™URL">Importer URL</button>
      <button id="resetBtn" class="btn-danger" aria-label="Tout effacer">Tout effacer</button>

      <!-- A5 : Bouton de partage -->
      <button id="shareBtn" class="btn-primary" aria-label="Copier le lien de comparaison">ðŸ”— Copier le lien</button>
      <!-- A9 START: Bouton de copie de lâ€™Ã©tat complet -->
<button id="copyStateBtn" class="btn-primary" aria-label="Copier lâ€™Ã©tat complet">ðŸ“‹ Ã‰tat complet</button>
<!-- A9 END -->


      <button id="refreshBtn" class="btn-muted" aria-label="RafraÃ®chir les calculs">â†» Recalculer</button>


      <!-- A6 : Compteur + Retirer tout -->
      <span id="counter" class="help" aria-live="polite" style="margin-left:auto">0 article</span>
      <button id="removeAllBtn" class="btn-ghost" aria-label="Retirer tous les produits">Retirer tout</button>
      <!-- A7 START: Recherche locale -->
      <input id="searchInput" type="text" placeholder="Rechercher (nom, marque, EAN)" aria-label="Rechercher dans la liste" style="min-width:240px">
      <button id="clearFilterBtn" class="btn-ghost" aria-label="Effacer le filtre">Effacer filtre</button>
<!-- A7 END -->



    </div>

    <p class="help">Astuce : vous pouvez passer plusieurs EAN via lâ€™URL, ex. <code>?eans=123,456,789</code>. Le tri, lâ€™option rang et lâ€™URL partagÃ©e sont sauvegardÃ©s localement.</p>

    <section id="track" class="tracks" aria-live="polite">
      <div class="empty">Aucun produit pour lâ€™instant. Ajoutez un EAN pour commencer.</div>
    </section>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite" style="position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:999px;font-size:13px;opacity:0;transition:.25s"></div>

  <script>
  // ===== Utilitaires UI =====
  const $ = (s)=>document.querySelector(s);
  const track = $("#track");
  const input = $("#eanInput");
  const addBtn = $("#addBtn");
  const clearBtn = $("#clearBtn");
  const importUrlBtn = $("#importUrlBtn");
  const resetBtn = $("#resetBtn");
  const sortSelect = $("#sortSelect");
  const toggleRank = $("#toggleRank");
  const refreshBtn = $("#refreshBtn");
  const toast = $("#toast");
  const shareBtn = document.getElementById("shareBtn");
  const counter = document.getElementById("counter");
  const removeAllBtn = document.getElementById("removeAllBtn");

  const STORAGE_KEY = "honoua:compare:eanList";
  const PREF_KEY = "honoua:compare:prefs";

  // A7: rÃ©fÃ©rences filtre
  const searchInput = document.getElementById("searchInput");
  const clearFilterBtn = document.getElementById("clearFilterBtn");

  // A9: bouton â€œÃ©tat completâ€
  const copyStateBtn = document.getElementById("copyStateBtn");

  // A8: contrÃ´les ordre / dÃ©partage
  const orderSelect = document.getElementById("orderSelect");
  const tiebreakSelect = document.getElementById("tiebreakSelect");

  // Ã‰tat
  let eans = loadEans();
  let prefs = loadPrefs(); // { sort, showRank, order, tiebreak, filter }
  let compareCache = {};   // { ean: {raw:number, norm:number} }

  // A10 â€” Restauration automatique de lâ€™Ã©tat depuis lâ€™URL
  function restoreStateFromUrl() {
    const params = new URLSearchParams(location.search);
    const hasRank = params.has("rank");
    const fromUrl = {
      eans: params.get("eans"),
      sort: params.get("sort"),
      rank: hasRank ? (params.get("rank") === "1" || params.get("rank")==="true") : null,
      order: params.get("order"),
      tiebreak: params.get("tiebreak"),
      filter: params.get("filter")
    };

    // EANs depuis URL
    if (fromUrl.eans) {
      eans = fromUrl.eans.split(",").map(s => s.trim()).filter(Boolean);
      saveEans();
    }
    // Prefs depuis URL (si prÃ©sents)
    if (fromUrl.sort) prefs.sort = fromUrl.sort;
    if (fromUrl.rank !== null) prefs.showRank = !!fromUrl.rank;
    if (fromUrl.order) prefs.order = fromUrl.order;
    if (fromUrl.tiebreak) prefs.tiebreak = fromUrl.tiebreak;
    if (typeof fromUrl.filter === "string") prefs.filter = fromUrl.filter;

    savePrefs();
  }

  // Mettre Ã  jour lâ€™URL quand lâ€™Ã©tat change
  function syncUrlState() {
    const params = new URLSearchParams();
    if (eans.length) params.set("eans", eans.join(","));
    if (prefs.sort) params.set("sort", prefs.sort);
    if (typeof prefs.showRank === "boolean") params.set("rank", prefs.showRank ? "1" : "0");
    if (prefs.order) params.set("order", prefs.order);
    if (prefs.tiebreak) params.set("tiebreak", prefs.tiebreak);
    if (prefs.filter) params.set("filter", prefs.filter);
    const newUrl = `${location.pathname}?${params.toString()}`;
    history.replaceState({}, "", newUrl);
  }

  restoreStateFromUrl();

  // Init UI
  if (!prefs) prefs = {};
  if (!prefs.sort) prefs.sort = "best";
  if (typeof prefs.showRank !== "boolean") prefs.showRank = false;
  if (!prefs.order) prefs.order = "asc";               // A8
  if (!prefs.tiebreak) prefs.tiebreak = "name";        // A8
  if (typeof prefs.filter !== "string") prefs.filter = "";

  if (sortSelect) sortSelect.value = prefs.sort;
  if (toggleRank) toggleRank.checked = !!prefs.showRank;
  if (orderSelect) orderSelect.value = prefs.order;
  if (tiebreakSelect) tiebreakSelect.value = prefs.tiebreak;
  if (searchInput) searchInput.value = prefs.filter;

  // Rendu initial
  render();
  refreshCompare();
  updateCounter();
  applyFilter();     // appliquer le filtre au dÃ©marrage
  syncUrlState();    // A10: synchroniser lâ€™URL aprÃ¨s premier rendu

  // ---- Events
  addBtn.addEventListener("click", ()=> {
    const val = (input.value||"").replace(/\s+/g,"");
    if(!val){ notify("Entrez un EAN."); input.focus(); return; }
    if(addEAN(val)){ input.value=""; input.focus(); refreshCompare(); syncUrlState(); }
  });
  input.addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ addBtn.click(); }});
  clearBtn.addEventListener("click", ()=>{ input.value=""; notify("Champ vidÃ©."); input.focus(); });

  importUrlBtn.addEventListener("click", importFromUrl);

  resetBtn.addEventListener("click", ()=>{
    if(confirm("Tout effacer de la comparaison ?")){
      eans = []; saveEans(); compareCache={}; render(); updateCounter(); syncUrlState();
      notify("Comparateur rÃ©initialisÃ©."); input.focus();
    }
  });

  sortSelect.addEventListener("change", ()=>{
    prefs.sort = sortSelect.value; savePrefs(); sortCards(); paintRanks(); syncUrlState();
  });
  toggleRank.addEventListener("change", ()=>{
    prefs.showRank = toggleRank.checked; savePrefs(); paintRanks(); syncUrlState();
  });

  // A8: ordre / dÃ©partage
  orderSelect?.addEventListener("change", ()=>{
    prefs.order = orderSelect.value; savePrefs(); sortCards(); paintRanks(); syncUrlState();
  });
  tiebreakSelect?.addEventListener("change", ()=>{
    prefs.tiebreak = tiebreakSelect.value; savePrefs(); sortCards(); paintRanks(); syncUrlState();
  });

  refreshBtn.addEventListener("click", ()=>{ refreshCompare(true); });

  // A5 â€” Partage (minimal)
  shareBtn?.addEventListener("click", async ()=>{
    const url = buildShareUrl();
    try{
      await copyToClipboard(url);
      notify("Lien copiÃ© dans le presse-papiers !");
    }catch{
      notify("Impossible de copier. SÃ©lectionnez lâ€™URL manuellement.");
      prompt("Copiez cette URL :", url);
    }
  });

  // A9 â€” Copier lâ€™Ã©tat complet
  copyStateBtn?.addEventListener("click", async ()=>{
    const url = buildShareUrl(true); // inclut order/tiebreak/filter
    try{
      await copyToClipboard(url);
      notify("Lien (Ã©tat complet) copiÃ© !");
    }catch{
      notify("Impossible de copier. SÃ©lectionnez lâ€™URL manuellement.");
      prompt("Copiez cette URL :", url);
    }
  });

  // A6 â€” Retirer tout
  removeAllBtn?.addEventListener("click", () => {
    if (!eans.length) { notify("Rien Ã  retirer."); input.focus(); return; }
    if (confirm(`Retirer ${eans.length} produit(s) de la comparaison ?`)) {
      eans = [];
      saveEans();
      compareCache = {};
      render();
      updateCounter();
      syncUrlState();
      notify("Tous les produits ont Ã©tÃ© retirÃ©s.");
      input.focus();
    }
  });

  // A7 â€” filtre temps rÃ©el
  searchInput?.addEventListener("input", () => {
    prefs.filter = searchInput.value || "";
    savePrefs();
    applyFilter();
    updateCounter();
    syncUrlState();
  });
  clearFilterBtn?.addEventListener("click", () => {
    if (!searchInput) return;
    searchInput.value = "";
    prefs.filter = "";
    savePrefs();
    applyFilter();
    updateCounter();
    syncUrlState();
    input.focus();
  });

  // ---- Prefs / EANs
  function loadPrefs(){
    try{ return JSON.parse(localStorage.getItem(PREF_KEY)||"{}"); }catch{ return {}; }
  }
  function savePrefs(){ localStorage.setItem(PREF_KEY, JSON.stringify(prefs)); }
  function loadEans(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      if(!arr.length){
        const params = new URLSearchParams(location.search);
        const csv = (params.get("eans")||"").trim();
        if(csv){ return csv.split(",").map(s=>s.trim()).filter(Boolean); }
      }
      return arr;
    }catch{ return []; }
  }
  function saveEans(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(eans)); }
  function addEAN(val, silent=false){
    if(!/^\d{8,14}$/.test(val)){ if(!silent) notify("EAN invalide."); input.focus(); return false; }
    if(eans.includes(val)){ if(!silent) notify("DÃ©jÃ  prÃ©sent."); input.focus(); return false; }
    eans.push(val); saveEans(); render(); updateCounter(); if(!silent) notify("Produit ajoutÃ©."); return true;
  }

  // ---- UI
  function render(){
    track.innerHTML = "";
    if(eans.length===0){
      const d = document.createElement("div");
      d.className="empty";
      d.innerHTML = `Aucun produit. <br/>Saisissez un EAN ou utilisez <code>?eans=</code>.`;
      track.appendChild(d);
      refreshBtn.disabled = true;
      updateCounter();
      return;
    }
    refreshBtn.disabled = false;
    for(const code of eans){
      const card = makeCardSkeleton(code);
      track.appendChild(card);
      hydrateCard(card, code);
    }
    updateCounter();
    applyFilter(); // re-appliquer aprÃ¨s hydratation
  }

  function makeCardSkeleton(code){
    const el = document.createElement("article");
    el.className="card";
    el.dataset.ean = code;
    el.innerHTML = `
      <span class="rank" aria-hidden="true" data-role="rank">#â€”</span>
      <div class="meta">EAN : <strong>${code}</strong></div>
      <div class="thumb shimmer" data-role="thumb" aria-busy="true">Chargementâ€¦</div>
      <h3 data-role="title">â€”</h3>
      <div class="meta" data-role="brand">â€”</div>

      <span class="badge" title="Empreinte normalisÃ©e sur la sÃ©lection">
        <span class="dot" data-role="dot"></span>
        <span data-role="fp-label">Empreinte : â€”</span>
      </span>
      <div class="gauge" aria-label="niveau d'empreinte"><i data-role="bar"></i></div>
      <div class="gauge-label" data-role="glabel">â€”</div>

      <div class="row" style="margin-top:12px">
        <button class="btn-ghost" data-action="remove" aria-label="Retirer ce produit">Retirer</button>
      </div>
    `;
    el.querySelector('[data-action="remove"]').addEventListener("click", ()=>{
      eans = eans.filter(v=>v!==code);
      saveEans(); delete compareCache[code];
      render(); updateCounter(); refreshCompare(); syncUrlState();
      notify("Produit retirÃ©."); input.focus();
    });
    return el;
  }

  async function hydrateCard(card, code){
    const $t = (sel)=>card.querySelector(sel);
    let data=null;
    try{
      let r = await fetch(`/products/${encodeURIComponent(code)}`);
      if(r.ok){ data = await r.json(); }
      if(!data || data.error){
        const q = await fetch(`/products?ean=${encodeURIComponent(code)}`);
        if(q.ok){
          const list = await q.json();
          data = Array.isArray(list) ? list[0] : list;
        }
      }
    }catch(e){}
    const th = $t('[data-role="thumb"]');
    th.classList.remove("shimmer"); th.removeAttribute("aria-busy");
    if(!data){
      th.textContent = "Introuvable";
      $t('[data-role="title"]').textContent = "Produit non trouvÃ©";
      $t('[data-role="brand"]').textContent = "â€”";
      applyFilter();
      return;
    }
    const title = data.name || data.product_name || data.title || "Produit";
    const brand = data.brand || data.brands || "â€”";
    const image = data.image_url || data.image || data.thumbnail || null;
    $t('[data-role="title"]').textContent = title;
    $t('[data-role="brand"]').textContent = brand;
    if(image){
      const img = new Image();
      img.alt = title; img.loading = "lazy";
      img.style.width="100%"; img.style.height="120px"; img.style.objectFit="contain"; img.style.borderRadius="10px";
      img.src = image; th.replaceWith(img);
    }else{
      th.textContent = "Pas dâ€™image";
    }
    // re-appliquer le filtre/surbrillance aprÃ¨s hydratation des textes
    applyFilter();
  }

  // ===== Calculs + tri/rang =====
  async function refreshCompare(force=false){
    if(!eans.length) return;
    if(!force && Object.keys(compareCache).length && eans.every(e=>compareCache[e])){
      sortCards(); paintRanks(); return;
    }
    let table=null;
    try{
      const url = `/compare?eans=${encodeURIComponent(eans.join(','))}`;
      const r = await fetch(url);
      if(r.ok){ table = await r.json(); }
    }catch(e){ table=null; }

    const byEan = {};
    if(Array.isArray(table)){
      for(const row of table){
        const ean = (row.ean || row.code || row.id || "").toString();
        const fp = pickFootprint(row);
        if(ean && fp!=null && !isNaN(fp)){ byEan[ean] = Number(fp); }
      }
    }

    const vals = Object.values(byEan);
    const min = vals.length ? Math.min(...vals) : 0;
    const max = vals.length ? Math.max(...vals) : 1;
    const span = Math.max(1e-9, max - min);

    compareCache = {};
    for(const e of eans){
      if(byEan[e]!=null){
        const raw = byEan[e];
        const norm = (raw - min)/span; // 0 meilleur â†’ 1 pire
        compareCache[e] = { raw, norm };
      }
    }

    document.querySelectorAll('.card').forEach(card=>{
      const ean = card.dataset.ean;
      const bar = card.querySelector('[data-role="bar"]');
      const dot = card.querySelector('[data-role="dot"]');
      const lab = card.querySelector('[data-role="fp-label"]');
      const glb = card.querySelector('[data-role="glabel"]');
      if(!compareCache[ean]){
        bar.style.width='0%'; dot.style.background='#bbb'; lab.textContent='Empreinte : â€”'; glb.textContent='â€”';
        return;
      }
      const {raw, norm} = compareCache[ean];
      const pct = Math.round(norm*100);
      bar.style.width = Math.max(6,pct)+'%';
      dot.style.background = mixColor('#2e7d32','#F5C147', norm);
      lab.textContent = `Empreinte : ${fmt(raw)}`;
      glb.textContent = (pct<=25?'TrÃ¨s faible':pct<=50?'Faible':pct<=75?'Moyenne':'Ã‰levÃ©e');
    });

    sortCards(); paintRanks();
  }

  function sortCards(){
    const cards = Array.from(document.querySelectorAll('.card'));
    const sort = prefs.sort || 'best';
    const order = (prefs.order === 'desc') ? -1 : 1; // asc=1, desc=-1
    const tiebreak = prefs.tiebreak || 'name';
    const collator = new Intl.Collator('fr',{sensitivity:'base',numeric:true});

    const items = cards.map(c=>{
      const ean = c.dataset.ean;
      const title = (c.querySelector('[data-role="title"]')?.textContent||'').trim();
      const brand = (c.querySelector('[data-role="brand"]')?.textContent||'').trim();
      const fp = compareCache[ean]?.raw;
      const norm = compareCache[ean]?.norm;
      return {el:c, ean, title, brand, fp, norm};
    });

    const cmpText = (a,b,field)=>{
      const A = (field==='ean') ? a.ean : (field==='brand' ? a.brand||'' : a.title||'');
      const B = (field==='ean') ? b.ean : (field==='brand' ? b.brand||'' : b.title||'');
      return collator.compare(A, B);
    };

    items.sort((a,b)=>{
      if (sort==='best' || sort==='worst'){
        const dir = (sort==='best') ? 1 : -1;
        const A = (a.norm==null) ? Infinity : a.norm;
        const B = (b.norm==null) ? Infinity : b.norm;
        if (A !== B) return dir * (A - B);
        const Afp = (a.fp==null) ? Infinity : a.fp;
        const Bfp = (b.fp==null) ? Infinity : b.fp;
        if (Afp !== Bfp) return dir * (Afp - Bfp);
        const t = cmpText(a,b,tiebreak);
        if (t !== 0) return t;
        return collator.compare(a.ean, b.ean);
      }
      if (sort==='brand'){
        const r = cmpText(a,b,'brand'); if (r!==0) return order*r;
        const r2 = cmpText(a,b,'name'); if (r2!==0) return order*r2;
        return order*collator.compare(a.ean, b.ean);
      }
      if (sort==='name'){
        const r = cmpText(a,b,'name'); if (r!==0) return order*r;
        const r2 = cmpText(a,b,'brand'); if (r2!==0) return order*r2;
        return order*collator.compare(a.ean, b.ean);
      }
      if (sort==='ean'){
        return order*collator.compare(a.ean, b.ean);
      }
      return 0;
    });

    items.forEach(i=>track.appendChild(i.el));
  }

  function paintRanks(){
    const show = !!prefs.showRank;
    const cards = Array.from(document.querySelectorAll('.card'));
    cards.forEach((c,idx)=>{
      const rk = c.querySelector('[data-role="rank"]');
      rk.textContent = `#${idx+1}`;
      rk.classList.toggle('show', show);
      rk.style.background = idx===0 ? '#2e7d32' : '#111';
    });
  }

  // ---- Helpers
  // A9 â€” import enrichi depuis lâ€™URL (inclut tri/ordre/dÃ©partage/filtre)
  function importFromUrl(){
    const params = new URLSearchParams(location.search);

    // EANs
    const csv = (params.get("eans")||"").trim();
    let added=0;
    if(csv){
      const list = csv.split(",").map(s=>s.trim()).filter(Boolean);
      list.forEach(v=> { if(addEAN(v,true)) added++; });
    }

    // PrÃ©fÃ©rences : sort, rank, order, tiebreak, filter
    const incoming = {
      sort: params.get("sort"),
      rank: params.get("rank"),
      order: params.get("order"),
      tiebreak: params.get("tiebreak"),
      filter: params.get("filter"),
    };

    let changed = false;

    if(incoming.sort && incoming.sort !== prefs.sort){ prefs.sort = incoming.sort; changed = true; }
    if(incoming.rank!=null){
      const val = incoming.rank === "1" || incoming.rank === "true";
      if(val !== !!prefs.showRank){ prefs.showRank = val; changed = true; }
    }
    if(incoming.order && incoming.order !== prefs.order){ prefs.order = incoming.order; changed = true; }
    if(incoming.tiebreak && incoming.tiebreak !== prefs.tiebreak){ prefs.tiebreak = incoming.tiebreak; changed = true; }
    if(typeof incoming.filter === "string"){
      const q = (incoming.filter||"").trim();
      if(q !== (prefs.filter||"")){ prefs.filter = q; changed = true; }
    }

    // RÃ©percuter dans lâ€™UI
    if(changed){
      savePrefs();
      if(sortSelect && prefs.sort) sortSelect.value = prefs.sort;
      if(toggleRank) toggleRank.checked = !!prefs.showRank;
      if(orderSelect && prefs.order) orderSelect.value = prefs.order;
      if(tiebreakSelect && prefs.tiebreak) tiebreakSelect.value = prefs.tiebreak;
      if(searchInput && typeof prefs.filter === "string") searchInput.value = prefs.filter;
    }

    if(added>0){ saveEans(); render(); notify(`${added} EAN importÃ©(s).`); }
    else if(!changed){ notify("Aucun paramÃ¨tre nouveau Ã  importer."); }

    // Toujours recalculer/synchroniser lâ€™affichage
    updateCounter();
    refreshCompare(true);
    applyFilter();
    sortCards();
    paintRanks();
    syncUrlState();   // <â€” sync Ã  la fin, une seule fois
  }

  function pickFootprint(row){
    const map = {}; for(const k of Object.keys(row)){ map[k.toLowerCase()] = k; }
    const candidates = ['footprint','co2e','co2eq','carbon','ghg','score','value'];
    for(const c of candidates){ if(map[c]) return toNumber(row[map[c]]); }
    return null;
  }
  function toNumber(v){
    if(v==null) return null;
    if(typeof v === 'number') return v;
    const s = String(v).replace(',', '.').replace(/[^\d.\-eE]/g,'');
    const n = parseFloat(s); return isNaN(n) ? null : n;
  }
  function fmt(v){
    if(v>=1000) return (v/1000).toFixed(2)+'k';
    if(v>=100) return v.toFixed(0);
    if(v>=10) return v.toFixed(1);
    return v.toFixed(2);
  }
  function mixColor(hexA, hexB, t){
    const a = hexToRgb(hexA), b = hexToRgb(hexB);
    const m = {r:Math.round(a.r+(b.r-a.r)*t), g:Math.round(a.g+(b.g-a.g)*t), b:Math.round(a.b+(b.b-a.b)*t)};
    return `rgb(${m.r},${m.g},${m.b})`;
  }
  function hexToRgb(h){
    const x = h.replace('#','');
    const n = parseInt(x.length===3 ? x.split('').map(c=>c+c).join('') : x, 16);
    return {r:(n>>16)&255, g:(n>>8)&255, b:(n)&255};
  }
  function notify(msg){
    toast.textContent = msg; toast.style.opacity=1;
    setTimeout(()=>toast.style.opacity=0, 1400);
  }

  // A5 â€” helpers partage + A9 (Ã©tat complet)
  function buildShareUrl(full=false){
    const base = location.origin + location.pathname;
    const params = new URLSearchParams();

    if(eans.length) params.set("eans", eans.join(","));
    if(prefs?.sort) params.set("sort", prefs.sort);
    if(typeof prefs?.showRank === "boolean") params.set("rank", prefs.showRank ? "1" : "0");

    if(full){
      if(prefs?.order) params.set("order", prefs.order);
      if(prefs?.tiebreak) params.set("tiebreak", prefs.tiebreak);
      if(prefs?.filter){ const q=(prefs.filter||"").trim(); if(q) params.set("filter", q); }
    }

    const qs = params.toString();
    return qs ? `${base}?${qs}` : base;
  }

  // A7 â€” filtre & surbrillance
  function normalize(s) { return (s||"").toString().toLowerCase(); }
  function highlightText(el, text, q) {
    if (!q) { el.innerHTML = escapeHtml(text); return; }
    const t = text || "";
    const idx = t.toLowerCase().indexOf(q.toLowerCase());
    if (idx < 0) { el.innerHTML = escapeHtml(t); return; }
    const before = escapeHtml(t.slice(0, idx));
    const match  = escapeHtml(t.slice(idx, idx + q.length));
    const after  = escapeHtml(t.slice(idx + q.length));
    el.innerHTML = `${before}<mark>${match}</mark>${after}`;
  }
  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, m => (
      m === '&' ? '&amp;' :
      m === '<' ? '&lt;'  :
      m === '>' ? '&gt;'  :
      m === '"' ? '&quot;': '&#39;'
    ));
  }
  function applyFilter() {
    const q = (prefs.filter || "").trim();
    const cards = Array.from(document.querySelectorAll('.card'));
    let visible = 0;

    for (const c of cards) {
      const ean = c.dataset.ean || "";
      const titleEl = c.querySelector('[data-role="title"]');
      const brandEl = c.querySelector('[data-role="brand"]');

      const title = (titleEl?.textContent || "").trim();
      const brand = (brandEl?.textContent || "").trim();
      const hay = `${title} ${brand} ${ean}`;

      const match = !q || normalize(hay).includes(normalize(q));
      c.style.display = match ? "" : "none";
      if (match) visible++;

      if (match) {
        if (titleEl) highlightText(titleEl, title, q);
        if (brandEl) highlightText(brandEl, brand, q);
      } else {
        if (titleEl) titleEl.innerHTML = escapeHtml(title);
        if (brandEl) brandEl.innerHTML = escapeHtml(brand);
      }
    }

    const empty = document.querySelector('.tracks .empty');
    if (cards.length && visible === 0) {
      if (!empty) {
        const d = document.createElement("div");
        d.className = "empty";
        d.textContent = "Aucun rÃ©sultat pour ce filtre.";
        document.querySelector('.tracks')?.appendChild(d);
      } else {
        empty.textContent = "Aucun rÃ©sultat pour ce filtre.";
        empty.style.display = "";
      }
    } else if (empty) {
      empty.style.display = "none";
    }
  }

  // A6/A7 â€” compteur (prend en compte le filtre actif)
  function updateCounter() {
    const hasFilter = !!(prefs.filter && prefs.filter.trim());
    const cards = Array.from(document.querySelectorAll('.card'));
    const visible = cards.filter(c => c.style.display !== 'none').length;

    const n = hasFilter ? visible : eans.length;
    if (counter) {
      counter.textContent = `${n} ${n > 1 ? "articles" : "article"}`;
    }
  }
</script>

</body>
</html>
