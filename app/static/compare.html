<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Honoua — Comparateur</title>
  <style>
    :root{
      --green:#2e7d32; --orange:#F5C147; --blue:#001D85;
      --bg:#f7f7f8; --ink:#111; --muted:#70757a; --card:#fff; --line:#e6e6e9;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    header{
      position:sticky;top:0;z-index:5;background:var(--card);border-bottom:1px solid var(--line);
      display:flex;align-items:center;gap:12px;padding:10px 14px;height:60px;
    }
    .logo{width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,#062909,var(--blue));}
    .titles{flex:1;text-align:center}
    .titles h1{margin:0;font-size:18px;line-height:1;font-weight:700;letter-spacing:.2px}
    .titles p{margin:2px 0 0;font-size:12px;color:var(--muted)}
    main{padding:12px}
    .bar{
      display:flex;gap:8px;align-items:center;padding:10px;background:var(--card);
      border:1px solid var(--line);border-radius:14px;
    }
    input[type="text"]{
      flex:1;border:1px solid var(--line);border-radius:10px;padding:10px 12px;font-size:14px;outline:none;background:#fff;
    }
    button{border:0;border-radius:12px;padding:10px 14px;font-weight:700;font-size:14px;cursor:pointer}
    .btn-primary{background:var(--blue);color:#fff}
    .btn-ghost{background:transparent;border:1px solid var(--line);color:var(--ink)}
    .btn-danger{background:#111;color:#fff;border:1px solid #000}
    .help{font-size:12px;color:var(--muted);margin:8px 2px}
    .tracks{
      margin-top:12px;background:var(--card);border:1px solid var(--line);border-radius:14px;padding:10px;
      display:flex;gap:8px;overflow-x:auto;scroll-snap-type:x mandatory;
    }
    .card{
      min-width:220px;max-width:240px;background:#fff;border:1px solid var(--line);border-radius:16px;
      padding:12px;scroll-snap-align:start;box-shadow:0 1px 0 rgba(0,0,0,.04);
    }
    .card h3{margin:6px 0 4px;font-size:14px}
    .meta{font-size:12px;color:var(--muted);margin-bottom:8px}
    .thumb{
      width:100%;height:120px;border-radius:12px;background:#f2f3f5;border:1px dashed var(--line);
      display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--muted);
    }
    .row{display:flex;gap:8px;margin-top:10px}
    .row button{flex:1}
    .empty{padding:16px;text-align:center;color:var(--muted);font-size:13px}

    /* Badge + jauge A3 */
    .badge{
      display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:6px 8px;border-radius:999px;
      border:1px solid var(--line);background:#fafafa;margin-top:8px;
    }
    .badge .dot{width:10px;height:10px;border-radius:50%;background:var(--orange)}
    .gauge{
      width:85%; height:10px; border-radius:999px; background:#eee; margin-top:8px; position:relative; overflow:hidden;
      border:1px solid var(--line);
    }
    .gauge > i{
      content:""; position:absolute; left:0; top:0; height:100%; width:0%;
      border-radius:999px;
      background: linear-gradient(90deg, var(--green), var(--orange));
      transition: width .35s ease;
    }
    .gauge-label{font-size:12px;color:var(--muted);margin-top:4px}
  </style>
</head>
<body>
  <header>
    <div class="logo" aria-hidden="true"></div>
    <div class="titles">
      <h1>Comparateur carbone</h1>
      <p>Calculs de base — A3</p>
    </div>
    <div style="width:48px"></div>
  </header>

  <main>
    <div class="bar">
      <input id="eanInput" type="text" inputmode="numeric" placeholder="Ajouter un EAN (ex : 3017620422003)" />
      <button id="addBtn" class="btn-primary">Ajouter</button>
      <button id="clearBtn" class="btn-ghost" title="Réinitialiser">↺</button>
    </div>
    <p class="help">Astuce : vous pouvez passer plusieurs EAN via l’URL, ex. <code>?eans=123,456,789</code>.</p>

    <section id="track" class="tracks" aria-live="polite">
      <div class="empty">Aucun produit pour l’instant. Ajoutez un EAN pour commencer.</div>
    </section>

    <div class="row">
      <button id="importUrlBtn" class="btn-ghost">Importer depuis l’URL</button>
      <button id="resetBtn" class="btn-danger">Tout effacer</button>
    </div>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    const $ = (s)=>document.querySelector(s);
    const track = $("#track");
    const input = $("#eanInput");
    const addBtn = $("#addBtn");
    const clearBtn = $("#clearBtn");
    const importUrlBtn = $("#importUrlBtn");
    const resetBtn = $("#resetBtn");

    const STORAGE_KEY = "honoua:compare:eanList";
    let eans = loadEans();
    render(); // crée les cartes
    refreshCompare(); // tente un premier calcul s’il y a des EAN

    addBtn.addEventListener("click", ()=> {
      const val = (input.value||"").replace(/\s+/g,"");
      if(!val){return notify("Entrez un EAN.");}
      if(addEAN(val)){ input.value=""; input.focus(); refreshCompare(); }
    });
    input.addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ addBtn.click(); }});
    clearBtn.addEventListener("click", ()=>{ input.value=""; notify("Champ vidé."); });
    importUrlBtn.addEventListener("click", ()=>{
      const params = new URLSearchParams(location.search);
      const csv = (params.get("eans")||"").trim();
      if(!csv){ return notify("Aucun paramètre ?eans trouvé."); }
      const list = csv.split(",").map(s=>s.trim()).filter(Boolean);
      let added=0;
      list.forEach(v=> { if(addEAN(v,true)) added++; });
      if(added>0){ saveEans(); render(); notify(`${added} EAN importé(s).`); refreshCompare(); }
      else notify("Aucun EAN nouveau.");
    });
    resetBtn.addEventListener("click", ()=>{
      if(confirm("Tout effacer de la comparaison ?")){
        eans = []; saveEans(); render(); notify("Comparateur réinitialisé.");
      }
    });

    function notify(msg){
      let t = document.getElementById("toast");
      if(!t){t=document.createElement("div");t.id="toast";document.body.appendChild(t)}
      t.className="toast show"; t.textContent = msg;
      setTimeout(()=>t.classList.remove("show"), 1400);
    }
    function loadEans(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        if(!arr.length){
          const params = new URLSearchParams(location.search);
          const csv = (params.get("eans")||"").trim();
          if(csv){ return csv.split(",").map(s=>s.trim()).filter(Boolean); }
        }
        return arr;
      }catch{ return []; }
    }
    function saveEans(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(eans)); }
    function addEAN(val, silent=false){
      if(!/^\d{8,14}$/.test(val)){ if(!silent) notify("EAN invalide."); return false; }
      if(eans.includes(val)){ if(!silent) notify("Déjà présent."); return false; }
      eans.push(val); saveEans(); render(); if(!silent) notify("Produit ajouté."); return true;
    }

    async function render(){
      track.innerHTML = "";
      if(eans.length===0){
        const d = document.createElement("div");
        d.className="empty";
        d.textContent="Aucun produit pour l’instant. Ajoutez un EAN pour commencer.";
        track.appendChild(d);
        return;
      }
      for(const code of eans){
        const card = makeCardSkeleton(code);
        track.appendChild(card);
        hydrateCard(card, code);
      }
    }

    function makeCardSkeleton(code){
      const el = document.createElement("article");
      el.className="card";
      el.dataset.ean = code;
      el.innerHTML = `
        <div class="meta">EAN : <strong>${code}</strong></div>
        <div class="thumb" data-role="thumb">Chargement…</div>
        <h3 data-role="title">—</h3>
        <div class="meta" data-role="brand">—</div>

        <span class="badge">
          <span class="dot" data-role="dot"></span>
          <span data-role="fp-label">Empreinte : —</span>
        </span>
        <div class="gauge" aria-label="niveau d'empreinte"><i data-role="bar"></i></div>
        <div class="gauge-label" data-role="glabel">—</div>

        <div class="row" style="margin-top:12px">
          <button class="btn-ghost" data-action="remove">Retirer</button>
        </div>
      `;
      el.querySelector('[data-action="remove"]').addEventListener("click", ()=>{
        eans = eans.filter(v=>v!==code);
        saveEans(); render(); notify("Produit retiré."); refreshCompare();
      });
      return el;
    }

    async function hydrateCard(card, code){
      const $t = (sel)=>card.querySelector(sel);
      $t('[data-role="thumb"]').textContent = "Chargement…";
      let data=null;
      try{
        let r = await fetch(`/products/${encodeURIComponent(code)}`);
        if(r.ok){ data = await r.json(); }
        if(!data || (data && data.error)){
          const q = await fetch(`/products?ean=${encodeURIComponent(code)}`);
          if(q.ok){ 
            const list = await q.json();
            data = Array.isArray(list) ? list[0] : list; 
          }
        }
      }catch(e){}
      if(!data){
        $t('[data-role="thumb"]').textContent = "Introuvable";
        $t('[data-role="title"]').textContent = "Produit non trouvé";
        $t('[data-role="brand"]').textContent = "—";
        return;
      }
      const title = data.name || data.product_name || data.title || "Produit";
      const brand = data.brand || data.brands || "—";
      const image = data.image_url || data.image || data.thumbnail || null;

      $t('[data-role="title"]').textContent = title;
      $t('[data-role="brand"]').textContent = brand;

      const th = $t('[data-role="thumb"]');
      if(image){
        const img = new Image();
        img.alt = title; img.loading = "lazy";
        img.style.width="100%"; img.style.height="120px"; img.style.objectFit="contain"; img.style.borderRadius="10px";
        img.src = image; th.replaceWith(img);
      }else{
        th.textContent = "Pas d’image";
      }
    }

    // ===== A3 — calculs de base via /compare?eans=... =====
    async function refreshCompare(){
      if(!eans.length) return;
      // Appel GET /compare?eans=CSV — tolérant aux schémas de champs
      let table=null;
      try{
        const url = `/compare?eans=${encodeURIComponent(eans.join(','))}`;
        const r = await fetch(url);
        if(r.ok){ table = await r.json(); }
      }catch(e){ table=null; }

      // Indexer par EAN pour maj rapide des cartes
      const byEan = {};
      if(Array.isArray(table)){
        for(const row of table){
          const ean = (row.ean || row.code || row.id || "").toString();
          const fp = pickFootprint(row); // valeur numérique (gCO2e, kgCO2e, score)
          if(ean && fp != null && !isNaN(fp)){ byEan[ean] = Number(fp); }
        }
      }

      // Normalisation min-max sur les EAN présents uniquement
      const vals = Object.values(byEan);
      const min = vals.length ? Math.min(...vals) : 0;
      const max = vals.length ? Math.max(...vals) : 1;
      const span = Math.max(1e-9, max - min);

      // Mise à jour UI
      document.querySelectorAll('.card').forEach(card=>{
        const ean = card.dataset.ean;
        const bar = card.querySelector('[data-role="bar"]');
        const dot = card.querySelector('[data-role="dot"]');
        const lab = card.querySelector('[data-role="fp-label"]');
        const glb = card.querySelector('[data-role="glabel"]');

        if(byEan[ean] == null){
          bar.style.width = '0%';
          dot.style.background = '#bbb';
          lab.textContent = 'Empreinte : —';
          glb.textContent = '—';
          return;
        }
        const raw = byEan[ean];
        const norm = (raw - min) / span; // 0 (meilleur) → 1 (pire)
        const pct = Math.round(norm * 100);

        bar.style.width = Math.max(6, pct) + '%'; // petite largeur mini lisible
        dot.style.background = mixColor('#2e7d32','#F5C147', norm);
        lab.textContent = `Empreinte : ${fmt(raw)}`;
        glb.textContent = (pct<=25?'Très faible':pct<=50?'Faible':pct<=75?'Moyenne':'Élevée');
      });
    }

    function pickFootprint(row){
      // Cherche un champ standard : footprint / co2e / carbon / score
      const keys = Object.keys(row).map(k=>k.toLowerCase());
      const map = {};
      for(const k of Object.keys(row)){ map[k.toLowerCase()] = k; }
      const candidates = ['footprint','co2e','co2eq','carbon','ghg','score','value'];
      for(const c of candidates){
        if(map[c]){ return toNumber(row[map[c]]); }
      }
      return null;
    }

    function toNumber(v){
      if(v==null) return null;
      if(typeof v === 'number') return v;
      const s = String(v).replace(',', '.').replace(/[^\d.\-eE]/g,'');
      const n = parseFloat(s);
      return isNaN(n) ? null : n;
    }

    function fmt(v){
      if(v>=1000) return (v/1000).toFixed(2)+'k';
      if(v>=100) return v.toFixed(0);
      if(v>=10) return v.toFixed(1);
      return v.toFixed(2);
    }

    // mélange simple de deux couleurs hex (pour le point)
    function mixColor(hexA, hexB, t){
      const a = hexToRgb(hexA), b = hexToRgb(hexB);
      const m = {r:Math.round(a.r+(b.r-a.r)*t), g:Math.round(a.g+(b.g-a.g)*t), b:Math.round(a.b+(b.b-a.b)*t)};
      return `rgb(${m.r},${m.g},${m.b})`;
    }
    function hexToRgb(h){
      const x = h.replace('#','');
      const n = parseInt(x.length===3 ? x.split('').map(c=>c+c).join('') : x, 16);
      return {r:(n>>16)&255, g:(n>>8)&255, b:n&255};
    }
  </script>
</body>
</html>
