<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Honoua — Comparateur</title>
  <style>
    :root{
      --green:#2e7d32; --orange:#F5C147; --blue:#001D85;
      --bg:#f7f7f8; --ink:#111; --muted:#70757a; --card:#fff; --line:#e6e6e9;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    header{
      position:sticky;top:0;z-index:5;background:var(--card);border-bottom:1px solid var(--line);
      display:flex;align-items:center;gap:12px;padding:10px 14px;height:60px;
    }
    .logo{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,#062909,var(--blue));}
    .titles{flex:1;min-width:0}
    .titles h1{margin:0;font-size:18px;line-height:1.1;font-weight:700;letter-spacing:.2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .titles p{margin:2px 0 0;font-size:12px;color:var(--muted)}
    main{padding:12px}
    .bar, .toolbar{
      display:flex;gap:8px;align-items:center;padding:10px;background:var(--card);
      border:1px solid var(--line);border-radius:14px;
    }
    .toolbar{margin-top:10px;flex-wrap:wrap}
    input[type="text"]{
      flex:1;border:1px solid var(--line);border-radius:10px;padding:10px 12px;font-size:14px;outline:none;background:#fff;
    }
    select{
      border:1px solid var(--line);border-radius:10px;padding:10px 12px;font-size:14px;background:#fff;min-width:180px;
    }
    label.switch{display:inline-flex;align-items:center;gap:8px;font-size:13px;color:var(--ink)}
    label.switch input{accent-color:var(--blue)}
    button{border:0;border-radius:12px;padding:10px 14px;font-weight:700;font-size:14px;cursor:pointer}
    .btn-primary{background:var(--blue);color:#fff}
    .btn-ghost{background:transparent;border:1px solid var(--line);color:var(--ink)}
    .btn-danger{background:#111;color:#fff;border:1px solid #000}
    .btn-muted{background:#e9eaee;color:#555;border:1px solid var(--line)}
    .help{font-size:12px;color:var(--muted);margin:8px 2px}
    .tracks{
      margin-top:12px;background:var(--card);border:1px solid var(--line);border-radius:14px;padding:10px;
      display:flex;gap:8px;overflow-x:auto;scroll-snap-type:x mandatory;
    }
    .card{
      min-width:220px;max-width:240px;background:#fff;border:1px solid var(--line);border-radius:16px;
      padding:12px;scroll-snap-align:start;box-shadow:0 1px 0 rgba(0,0,0,.04);position:relative;
    }
    .card h3{margin:6px 0 4px;font-size:14px}
    .meta{font-size:12px;color:var(--muted);margin-bottom:8px}
    .thumb{
      width:100%;height:120px;border-radius:12px;background:#f2f3f5;border:1px dashed var(--line);
      display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--muted);
    }
    .row{display:flex;gap:8px;margin-top:10px}
    .row button{flex:1}
    .empty{padding:16px;text-align:center;color:var(--muted);font-size:13px}
    /* Badge + jauge */
    .badge{
      display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:6px 8px;border-radius:999px;
      border:1px solid var(--line);background:#fafafa;margin-top:8px;
    }
    .badge .dot{width:10px;height:10px;border-radius:50%;background:var(--orange)}
    .rank{
      position:absolute;top:10px;left:10px;background:#111;color:#fff;border-radius:999px;
      font-size:12px;padding:4px 8px;line-height:1;display:none;
    }
    .rank.show{display:inline-block}
    .gauge{width:85%; height:10px; border-radius:999px; background:#eee; margin-top:8px; position:relative; overflow:hidden;border:1px solid var(--line)}
    .gauge > i{content:""; position:absolute; left:0; top:0; height:100%; width:0%; border-radius:999px;background: linear-gradient(90deg, var(--green), var(--orange)); transition: width .35s ease}
    .gauge-label{font-size:12px;color:var(--muted);margin-top:4px}
    /* Skeleton simple */
    .shimmer{background:linear-gradient(110deg,#eee 8%,#f5f5f7 18%,#eee 33%);background-size:200% 100%;animation:sh 1.2s linear infinite}
    @keyframes sh{to{background-position-x:-200%}}
  </style>
  <style>
/* ==========================================================================
   A11 — Mini-CSS Historique comparateur (sobre + accessible)
   - Scope strict: #compare-history pour éviter les collisions
   - Palette discrète Honoua (#062909, #F5C147, #001D85)
   - Compatibilité dark mode + focus visibles
   ========================================================================== */

#compare-history {
  margin-top: 1.25rem;
  padding-top: .5rem;
  border-top: 1px solid rgba(0,0,0,.08);
}

@media (prefers-color-scheme: dark) {
  #compare-history { border-top-color: rgba(255,255,255,.12); }
}

/* Barre d’actions (Étape 3) */
#compare-history .history-actions-bar {
  display: flex;
  align-items: center;
  gap: .5rem;
  margin: .25rem 0 1rem;
  flex-wrap: wrap;
}

/* Liste */
#compare-history #compare-history-list {
  display: grid;
  gap: .5rem;
}

/* Item */
#compare-history .history-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: .75rem;
  padding: .6rem .75rem;
  border: 1px solid rgba(0,0,0,.08);
  border-radius: .6rem;
  background: #fff;
}

@media (prefers-color-scheme: dark) {
  #compare-history .history-item {
    background: #0e0f11;
    border-color: rgba(255,255,255,.12);
  }
}

/* Meta (date + compte) */
#compare-history .history-meta {
  display: flex;
  align-items: center;
  gap: .35rem;
  font-size: .935rem;
  line-height: 1.2;
  color: #2a2a2a;
}

@media (prefers-color-scheme: dark) {
  #compare-history .history-meta { color: #e6e6e6; }
}

#compare-history .history-meta time {
  font-variant-numeric: tabular-nums;
}

/* Actions par item */
#compare-history .history-actions {
  display: flex;
  align-items: center;
  gap: .35rem;
}

/* Boutons — style minimal */
#compare-history button {
  -webkit-tap-highlight-color: transparent;
  appearance: none;
  border: 1px solid rgba(0,0,0,.10);
  background: #fff;
  color: #001D85; /* bleu discret par défaut */
  font: inherit;
  font-size: .9rem;
  padding: .4rem .6rem;
  border-radius: .5rem;
  cursor: pointer;
  transition: transform .06s ease, background-color .12s ease, border-color .12s ease, color .12s ease;
}

@media (prefers-color-scheme: dark) {
  #compare-history button {
    background: #121316;
    color: #c9d4ff;
    border-color: rgba(255,255,255,.14);
  }
}

#compare-history button:hover {
  background: rgba(0,29,133,.06);
}

@media (prefers-color-scheme: dark) {
  #compare-history button:hover {
    background: rgba(201,212,255,.08);
  }
}

/* Bouton principal: Recharger (accent vert) */
#compare-history .history-reload {
  color: #062909;
  border-color: rgba(6,41,9,.25);
}
#compare-history .history-reload:hover {
  background: rgba(6,41,9,.08);
}

/* Bouton secondaire: Épingler / Désépingler (accent orange) */
#compare-history .history-pin {
  color: #8a6200; /* dérivé de #F5C147 pour lisibilité */
  border-color: rgba(245,193,71,.45);
}
#compare-history .history-pin:hover {
  background: rgba(245,193,71,.12);
}

/* Bouton danger: Supprimer */
#compare-history .history-delete {
  color: #7a1111;
  border-color: rgba(122,17,17,.28);
}
#compare-history .history-delete:hover {
  background: rgba(122,17,17,.08);
}

/* Barre d’actions : Vider + filtre épinglés */
#compare-history #history-clear {
  color: #7a1111;
  border-color: rgba(122,17,17,.28);
}
#compare-history #history-clear:hover {
  background: rgba(122,17,17,.08);
}

/* Focus visibles (accessibilité) */
#compare-history button:focus-visible {
  outline: 2px solid #001D85;
  outline-offset: 2px;
}

/* Small screens */
@media (max-width: 520px) {
  #compare-history .history-item {
    flex-direction: column;
    align-items: stretch;
  }
  #compare-history .history-actions {
    justify-content: flex-end;
  }
}


    
#compare-export {
  display: flex;
  gap: 0.75rem;
  margin-top: 0.5rem;
}
#compare-export button {
  padding: 0.4rem 0.8rem;
  border: 1px solid rgba(0,0,0,.2);
  border-radius: 6px;
  background: #f8f8f8;
  cursor: pointer;
}
#compare-export button:hover {
  background: rgba(0,0,0,.05);
}
@media (prefers-color-scheme: dark){
  #compare-export button {
    background: rgba(255,255,255,.1);
    color: #eee;
  }
}


/* A14 — Statistiques */
#compare-stats {
  margin-top: 1rem;
  padding: .75rem;
  border-top: 1px solid rgba(0,0,0,.1);
}
#compare-stats h2 {
  margin-bottom: .5rem;
  font-size: 1.1rem;
}
#compare-stats .stats-summary {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  font-size: .9rem;
}
#compare-stats .stats-summary p {
  margin: 0;
}
@media (prefers-color-scheme: dark){
  #compare-stats {
    border-color: rgba(255,255,255,.1);
  }
}

/* Préférence utilisateur: réduire les animations */
@media (prefers-reduced-motion: reduce) {
  #compare-history button { transition: none; }
}

/* État épinglé (optionnel si tu veux un indicateur visuel)
   — Ajoute .is-pinned à .history-item lors du rendu si nécessaire.
*/
#compare-history .history-item.is-pinned {
  box-shadow: 0 0 0 2px rgba(245,193,71,.25) inset;
  border-color: rgba(245,193,71,.55);
}

/* Badge “Épinglé” (compact, discret, accessible) */
#compare-history .history-badge {
  margin-left: .5rem;
  padding: .1rem .4rem;
  border-radius: .4rem;
  font-size: .75rem;
  line-height: 1.2;
  background: rgba(245,193,71,.18); /* orange doux */
  color: #8a6200;
  border: 1px solid rgba(245,193,71,.35);
}

@media (prefers-color-scheme: dark) {
  #compare-history .history-badge {
    background: rgba(245,193,71,.15);
    color: #f6d686;
    border-color: rgba(245,193,71,.45);
  }
}

/* Pastille d’état (épinglée / actuelle / neutre) */
#compare-history .history-dot {
  width: .6rem; height: .6rem; border-radius: 999px;
  border: 1px solid rgba(0,0,0,.2);
  margin-right: .4rem; flex: 0 0 auto;
  background: #fff;
}
@media (prefers-color-scheme: dark){
  #compare-history .history-dot { background: #0e0f11; border-color: rgba(255,255,255,.2); }
}

/* Couleurs d’état */
#compare-history .history-item.is-pinned .history-dot { background: #F5C147; border-color: rgba(245,193,71,.7); }   /* épinglé (orange) */
#compare-history .history-item.is-current .history-dot { background: #001D85; border-color: rgba(0,29,133,.65); }    /* actuelle (bleu) */
#compare-history .history-item:not(.is-pinned):not(.is-current) .history-dot { background: #e9ecef; }

/* Ligne meta > on aligne pastille + contenu */
#compare-history .history-meta {
  display: flex; align-items: center; gap: .35rem; flex-wrap: wrap;
}
#compare-history .history-meta .meta-row {
  display: flex; align-items: center; gap: .35rem;
}

/* Badge “Actuelle” (différent du badge “Épinglé”) */
#compare-history .history-badge-current {
  margin-left: .25rem;
  padding: .1rem .4rem;
  border-radius: .4rem;
  font-size: .75rem;
  line-height: 1.2;
  background: rgba(0,29,133,.12);
  color: #001D85;
  border: 1px solid rgba(0,29,133,.35);
}
@media (prefers-color-scheme: dark){
  #compare-history .history-badge-current {
    background: rgba(0,29,133,.18);
    color: #c9d4ff;
    border-color: rgba(0,29,133,.45);
  }
}

/* Mini-chips de récapitulatif (tri, ordre, filtres, recherche) */
#compare-history .history-chips {
  display: flex; gap: .25rem; flex-wrap: wrap; margin-top: .25rem;
}
#compare-history .chip {
  padding: .15rem .45rem; font-size: .74rem; line-height: 1.2;
  border-radius: .4rem; border: 1px solid rgba(0,0,0,.12);
  background: #fff; color: #2a2a2a;
}
@media (prefers-color-scheme: dark){
  #compare-history .chip {
    background: #121316; color: #e6e6e6; border-color: rgba(255,255,255,.14);
  }
}
#compare-history .chip-sort   { border-color: rgba(6,41,9,.25); }           /* léger accent vert */
#compare-history .chip-order  { border-color: rgba(0,29,133,.35); }         /* léger accent bleu */
#compare-history .chip-filter { border-color: rgba(245,193,71,.45); }       /* léger accent orange */
#compare-history .chip-query  { border-style: dashed; }


/* A15 — Évolution carbone */
#compare-carbon {
  margin-top: 1rem;
  padding: .75rem;
  border-top: 1px solid rgba(0,0,0,.1);
}
#compare-carbon h2 { margin-bottom: .5rem; font-size: 1.1rem; }
#compare-carbon .carbon-summary, 
#compare-carbon .carbon-controls {
  display: flex; flex-wrap: wrap; gap: 1rem; font-size: .9rem; align-items: center;
}
#compare-carbon .carbon-summary p { margin: 0; }
#compare-carbon .carbon-note { font-size: .8rem; opacity: .8; margin-top: .5rem; }
@media (prefers-color-scheme: dark){
  #compare-carbon { border-color: rgba(255,255,255,.1); }
}

#compare-history #carbon-cache-clear {
  color: #7a1111;
  border-color: rgba(122,17,17,.28);
}
#compare-history #carbon-cache-clear:hover {
  background: rgba(122,17,17,.08);
}


/* A17 — Toast de confirmation */
#compare-history #history-toast{
  position: fixed; right: 1rem; bottom: 1rem;
  background: #0b5; color: #fff; padding: .5rem .75rem;
  border-radius: .5rem; box-shadow: 0 6px 20px rgba(0,0,0,.15);
  font-size: .9rem; z-index: 9999;
}
@media (prefers-color-scheme: dark){
  #compare-history #history-toast{ background:#0a7a4f; }
}
/* Bouton “Copier” (utilise styles boutons existants) */
#compare-history .history-copy{
  color:#001D85; border-color: rgba(0,29,133,.35);
}
#compare-history .history-copy:hover{ background: rgba(0,29,133,.08); }

#compare-history #history-toast{
  position: fixed; right: 1rem; bottom: 1rem;
  background: #0b5; color:#fff; padding:.5rem .75rem;
  border-radius:.5rem; box-shadow:0 6px 20px rgba(0,0,0,.15);
  font-size:.9rem; z-index:9999;
}
@media (prefers-color-scheme: dark){
  #compare-history #history-toast{ background:#0a7a4f; }
}
#compare-history .history-copy{
  color:#001D85; border-color: rgba(0,29,133,.35);
}
#compare-history .history-copy:hover{ background: rgba(0,29,133,.08); }


</style>

</head>
<body>
  <header>
    <div class="logo" aria-hidden="true"></div>
    <div class="titles">
      <h1>Comparateur carbone</h1>
      <p>A4–A6 — Tri, rang, partage, compteur, retirer tout</p>
    </div>
    <div style="width:40px"></div>
  </header>

  <main>
    <div class="bar" role="region" aria-label="Ajout de produits">
      <input id="eanInput" type="text" inputmode="numeric" placeholder="Ajouter un EAN (ex : 3017620422003)" aria-label="EAN à ajouter" />
      <button id="addBtn" class="btn-primary" aria-label="Ajouter le produit">Ajouter</button>
      <button id="clearBtn" class="btn-ghost" title="Réinitialiser le champ">↺</button>
    </div>

    <div class="toolbar" role="region" aria-label="Outils de comparaison">
      <select id="sortSelect" aria-label="Trier par">
        <option value="best">Trier : Meilleure empreinte d’abord</option>
        <option value="worst">Trier : Pire empreinte d’abord</option>
        <option value="brand">Trier : Marque (A→Z)</option>
        <option value="name">Trier : Nom (A→Z)</option>
        <option value="ean">Trier : EAN</option>
      </select>

      <label class="switch" title="Afficher le rang sur chaque carte">
        <input id="toggleRank" type="checkbox" /> Afficher le rang
      </label>
      <button id="importUrlBtn" class="btn-ghost" aria-label="Importer depuis l’URL">Importer URL</button>
      <button id="resetBtn" class="btn-danger" aria-label="Tout effacer">Tout effacer</button>

      <!-- A5 : Bouton de partage -->
      <button id="shareBtn" class="btn-primary" aria-label="Copier le lien de comparaison">🔗 Copier le lien</button>
      <!-- A9 START: Bouton de copie de l’état complet -->
<button id="copyStateBtn" class="btn-primary" aria-label="Copier l’état complet">📋 État complet</button>
<!-- A9 END -->
      <button id="refreshBtn" class="btn-muted" aria-label="Rafraîchir les calculs">↻ Recalculer</button>

         <!-- =======================================================================
     A11 — Historique des comparaisons (Étape 2 : affichage + rechargement)
     Section à placer sous le comparateur
     ======================================================================= -->
<section id="compare-history" aria-labelledby="compare-history-title" hidden>
  <h2 id="compare-history-title">Historique des comparaisons</h2>
  <div id="compare-history-list" role="list" aria-live="polite"></div>

  <!-- Barre d’actions (optionnelle, style minimal) -->
<div id="compare-history-actions" class="history-actions-bar" hidden>
  <button type="button" id="history-clear">Vider l’historique</button>
  <label style="margin-left:.5rem;">
    <input type="checkbox" id="history-show-pinned" />
    Afficher uniquement les épinglés
  </label>
  <button type="button" id="carbon-cache-clear">Purger cache carbone</button>
</div>
<div id="history-toast" aria-live="polite" hidden>—</div>

</section>

   <!-- =======================================================================
     A14 — Section statistiques de l'historique
     ======================================================================= -->
<section id="compare-stats" hidden>
  <h2>Statistiques d’utilisation</h2>
  <div class="stats-summary">
    <p><strong>Total :</strong> <span id="stat-total">0</span> sessions</p>
    <p><strong>7 derniers jours :</strong> <span id="stat-week">0</span></p>
    <p><strong>Épinglées :</strong> <span id="stat-pinned">0</span></p>
    <p><strong>Moyenne produits/session :</strong> <span id="stat-avg">0</span></p>
  </div>

  <canvas id="stat-chart" width="350" height="180" aria-label="Historique des sessions par jour"></canvas>
</section>
     

     <!-- =======================================================================
     A15 — Évolution carbone
     ======================================================================= -->
<section id="compare-carbon" hidden>
  <h2>Évolution carbone</h2>

  <div class="carbon-summary">
    <p><strong>Sessions comptabilisées :</strong> <span id="carbon-sessions">0</span></p>
    <p><strong>Moyenne globale :</strong> <span id="carbon-global-avg">—</span> gCO₂e/session</p>
  </div>

  <div class="carbon-controls">
    <label>Mode :
      <select id="carbon-mode">
        <option value="avg_per_session" selected>Moyenne par session (gCO₂e/session)</option>
        <option value="sum_per_session">Total par session (gCO₂e)</option>
      </select>
    </label>
  </div>

  <canvas id="carbon-chart" width="350" height="180" aria-label="Évolution carbone (journalier)"></canvas>
  <p class="carbon-note">NB : seules les sessions avec au moins une émission connue sont prises en compte.</p>
</section>


      <!-- =======================================================================
     A16 — Export CSV
     ======================================================================= -->
    <div id="compare-export">
       <button id="export-stats-csv">Exporter stats (CSV)</button>
        <button id="export-carbon-csv">Exporter carbone (CSV)</button>
    </div>
     
     <div id="history-toast" aria-live="polite" hidden>—</div>




      <!-- A6 : Compteur + Retirer tout -->
      <span id="counter" class="help" aria-live="polite" style="margin-left:auto">0 article</span>
      <button id="removeAllBtn" class="btn-ghost" aria-label="Retirer tous les produits">Retirer tout</button>
      <!-- A7 START: Recherche locale -->
      <input id="searchInput" type="text" placeholder="Rechercher (nom, marque, EAN)" aria-label="Rechercher dans la liste" style="min-width:240px">
      <button id="clearFilterBtn" class="btn-ghost" aria-label="Effacer le filtre">Effacer filtre</button>
<!-- A7 END -->



    </div>

    <p class="help">Astuce : vous pouvez passer plusieurs EAN via l’URL, ex. <code>?eans=123,456,789</code>. Le tri, l’option rang et l’URL partagée sont sauvegardés localement.</p>

    <section id="track" class="tracks" aria-live="polite">
      <div class="empty">Aucun produit pour l’instant. Ajoutez un EAN pour commencer.</div>
    </section>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite" style="position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:999px;font-size:13px;opacity:0;transition:.25s"></div>

  <script>
  // ===== Utilitaires UI =====
  const $ = (s)=>document.querySelector(s);
  const track = $("#track");
  const input = $("#eanInput");
  const addBtn = $("#addBtn");
  const clearBtn = $("#clearBtn");
  const importUrlBtn = $("#importUrlBtn");
  const resetBtn = $("#resetBtn");
  const sortSelect = $("#sortSelect");
  const toggleRank = $("#toggleRank");
  const refreshBtn = $("#refreshBtn");
  const toast = $("#toast");
  const shareBtn = document.getElementById("shareBtn");
  const counter = document.getElementById("counter");
  const removeAllBtn = document.getElementById("removeAllBtn");

  const STORAGE_KEY = "honoua:compare:eanList";
  const PREF_KEY = "honoua:compare:prefs";

  // A7: références filtre
  const searchInput = document.getElementById("searchInput");
  const clearFilterBtn = document.getElementById("clearFilterBtn");

  // A9: bouton “état complet”
  const copyStateBtn = document.getElementById("copyStateBtn");

  // A8: contrôles ordre / départage
  const orderSelect = document.getElementById("orderSelect");
  const tiebreakSelect = document.getElementById("tiebreakSelect");

  // État
  let eans = loadEans();
  let prefs = loadPrefs(); // { sort, showRank, order, tiebreak, filter }
  let compareCache = {};   // { ean: {raw:number, norm:number} }

  // A10 — Restauration automatique de l’état depuis l’URL
  function restoreStateFromUrl() {
    const params = new URLSearchParams(location.search);
    const hasRank = params.has("rank");
    const fromUrl = {
      eans: params.get("eans"),
      sort: params.get("sort"),
      rank: hasRank ? (params.get("rank") === "1" || params.get("rank")==="true") : null,
      order: params.get("order"),
      tiebreak: params.get("tiebreak"),
      filter: params.get("filter")
    };

    // EANs depuis URL
    if (fromUrl.eans) {
      eans = fromUrl.eans.split(",").map(s => s.trim()).filter(Boolean);
      saveEans();
    }
    // Prefs depuis URL (si présents)
    if (fromUrl.sort) prefs.sort = fromUrl.sort;
    if (fromUrl.rank !== null) prefs.showRank = !!fromUrl.rank;
    if (fromUrl.order) prefs.order = fromUrl.order;
    if (fromUrl.tiebreak) prefs.tiebreak = fromUrl.tiebreak;
    if (typeof fromUrl.filter === "string") prefs.filter = fromUrl.filter;

    savePrefs();
  }

  // Mettre à jour l’URL quand l’état change
  function syncUrlState() {
    const params = new URLSearchParams();
    if (eans.length) params.set("eans", eans.join(","));
    if (prefs.sort) params.set("sort", prefs.sort);
    if (typeof prefs.showRank === "boolean") params.set("rank", prefs.showRank ? "1" : "0");
    if (prefs.order) params.set("order", prefs.order);
    if (prefs.tiebreak) params.set("tiebreak", prefs.tiebreak);
    if (prefs.filter) params.set("filter", prefs.filter);
    const newUrl = `${location.pathname}?${params.toString()}`;
    history.replaceState({}, "", newUrl);
  }

  restoreStateFromUrl();

  // Init UI
  if (!prefs) prefs = {};
  if (!prefs.sort) prefs.sort = "best";
  if (typeof prefs.showRank !== "boolean") prefs.showRank = false;
  if (!prefs.order) prefs.order = "asc";               // A8
  if (!prefs.tiebreak) prefs.tiebreak = "name";        // A8
  if (typeof prefs.filter !== "string") prefs.filter = "";

  if (sortSelect) sortSelect.value = prefs.sort;
  if (toggleRank) toggleRank.checked = !!prefs.showRank;
  if (orderSelect) orderSelect.value = prefs.order;
  if (tiebreakSelect) tiebreakSelect.value = prefs.tiebreak;
  if (searchInput) searchInput.value = prefs.filter;

  // Rendu initial
  render();
  refreshCompare();
  updateCounter();
  applyFilter();     // appliquer le filtre au démarrage
  syncUrlState();    // A10: synchroniser l’URL après premier rendu

  // ---- Events
  addBtn.addEventListener("click", ()=> {
    const val = (input.value||"").replace(/\s+/g,"");
    if(!val){ notify("Entrez un EAN."); input.focus(); return; }
    if(addEAN(val)){ input.value=""; input.focus(); refreshCompare(); syncUrlState(); }
  });
  input.addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ addBtn.click(); }});
  clearBtn.addEventListener("click", ()=>{ input.value=""; notify("Champ vidé."); input.focus(); });

  importUrlBtn.addEventListener("click", importFromUrl);

  resetBtn.addEventListener("click", ()=>{
    if(confirm("Tout effacer de la comparaison ?")){
      eans = []; saveEans(); compareCache={}; render(); updateCounter(); syncUrlState();
      notify("Comparateur réinitialisé."); input.focus();
    }
  });

  sortSelect.addEventListener("change", ()=>{
    prefs.sort = sortSelect.value; savePrefs(); sortCards(); paintRanks(); syncUrlState();
  });
  toggleRank.addEventListener("change", ()=>{
    prefs.showRank = toggleRank.checked; savePrefs(); paintRanks(); syncUrlState();
  });

  // A8: ordre / départage
  orderSelect?.addEventListener("change", ()=>{
    prefs.order = orderSelect.value; savePrefs(); sortCards(); paintRanks(); syncUrlState();
  });
  tiebreakSelect?.addEventListener("change", ()=>{
    prefs.tiebreak = tiebreakSelect.value; savePrefs(); sortCards(); paintRanks(); syncUrlState();
  });

  refreshBtn.addEventListener("click", ()=>{ refreshCompare(true); });

  // A5 — Partage (minimal)
  shareBtn?.addEventListener("click", async ()=>{
    const url = buildShareUrl();
    try{
      await copyToClipboard(url);
      notify("Lien copié dans le presse-papiers !");
    }catch{
      notify("Impossible de copier. Sélectionnez l’URL manuellement.");
      prompt("Copiez cette URL :", url);
    }
  });

  // A9 — Copier l’état complet
  copyStateBtn?.addEventListener("click", async ()=>{
    const url = buildShareUrl(true); // inclut order/tiebreak/filter
    try{
      await copyToClipboard(url);
      notify("Lien (état complet) copié !");
    }catch{
      notify("Impossible de copier. Sélectionnez l’URL manuellement.");
      prompt("Copiez cette URL :", url);
    }
  });

  // A6 — Retirer tout
  removeAllBtn?.addEventListener("click", () => {
    if (!eans.length) { notify("Rien à retirer."); input.focus(); return; }
    if (confirm(`Retirer ${eans.length} produit(s) de la comparaison ?`)) {
      eans = [];
      saveEans();
      compareCache = {};
      render();
      updateCounter();
      syncUrlState();
      notify("Tous les produits ont été retirés.");
      input.focus();
    }
  });

  // A7 — filtre temps réel
  searchInput?.addEventListener("input", () => {
    prefs.filter = searchInput.value || "";
    savePrefs();
    applyFilter();
    updateCounter();
    syncUrlState();
  });
  clearFilterBtn?.addEventListener("click", () => {
    if (!searchInput) return;
    searchInput.value = "";
    prefs.filter = "";
    savePrefs();
    applyFilter();
    updateCounter();
    syncUrlState();
    input.focus();
  });

  // ---- Prefs / EANs
  function loadPrefs(){
    try{ return JSON.parse(localStorage.getItem(PREF_KEY)||"{}"); }catch{ return {}; }
  }
  function savePrefs(){ localStorage.setItem(PREF_KEY, JSON.stringify(prefs)); }
  function loadEans(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      if(!arr.length){
        const params = new URLSearchParams(location.search);
        const csv = (params.get("eans")||"").trim();
        if(csv){ return csv.split(",").map(s=>s.trim()).filter(Boolean); }
      }
      return arr;
    }catch{ return []; }
  }
  function saveEans(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(eans)); }
  function addEAN(val, silent=false){
    if(!/^\d{8,14}$/.test(val)){ if(!silent) notify("EAN invalide."); input.focus(); return false; }
    if(eans.includes(val)){ if(!silent) notify("Déjà présent."); input.focus(); return false; }
    eans.push(val); saveEans(); render(); updateCounter(); if(!silent) notify("Produit ajouté."); return true;
  }

  // ---- UI
  function render(){
    track.innerHTML = "";
    if(eans.length===0){
      const d = document.createElement("div");
      d.className="empty";
      d.innerHTML = `Aucun produit. <br/>Saisissez un EAN ou utilisez <code>?eans=</code>.`;
      track.appendChild(d);
      refreshBtn.disabled = true;
      updateCounter();
      return;
    }
    refreshBtn.disabled = false;
    for(const code of eans){
      const card = makeCardSkeleton(code);
      track.appendChild(card);
      hydrateCard(card, code);
    }
    updateCounter();
    applyFilter(); // re-appliquer après hydratation
  }

  function makeCardSkeleton(code){
    const el = document.createElement("article");
    el.className="card";
    el.dataset.ean = code;
    el.innerHTML = `
      <span class="rank" aria-hidden="true" data-role="rank">#—</span>
      <div class="meta">EAN : <strong>${code}</strong></div>
      <div class="thumb shimmer" data-role="thumb" aria-busy="true">Chargement…</div>
      <h3 data-role="title">—</h3>
      <div class="meta" data-role="brand">—</div>

      <span class="badge" title="Empreinte normalisée sur la sélection">
        <span class="dot" data-role="dot"></span>
        <span data-role="fp-label">Empreinte : —</span>
      </span>
      <div class="gauge" aria-label="niveau d'empreinte"><i data-role="bar"></i></div>
      <div class="gauge-label" data-role="glabel">—</div>

      <div class="row" style="margin-top:12px">
        <button class="btn-ghost" data-action="remove" aria-label="Retirer ce produit">Retirer</button>
      </div>
    `;
    el.querySelector('[data-action="remove"]').addEventListener("click", ()=>{
      eans = eans.filter(v=>v!==code);
      saveEans(); delete compareCache[code];
      render(); updateCounter(); refreshCompare(); syncUrlState();
      notify("Produit retiré."); input.focus();
    });
    return el;
  }

  async function hydrateCard(card, code){
    const $t = (sel)=>card.querySelector(sel);
    let data=null;
    try{
      let r = await fetch(`/products/${encodeURIComponent(code)}`);
      if(r.ok){ data = await r.json(); }
      if(!data || data.error){
        const q = await fetch(`/products?ean=${encodeURIComponent(code)}`);
        if(q.ok){
          const list = await q.json();
          data = Array.isArray(list) ? list[0] : list;
        }
      }
    }catch(e){}
    const th = $t('[data-role="thumb"]');
    th.classList.remove("shimmer"); th.removeAttribute("aria-busy");
    if(!data){
      th.textContent = "Introuvable";
      $t('[data-role="title"]').textContent = "Produit non trouvé";
      $t('[data-role="brand"]').textContent = "—";
      applyFilter();
      return;
    }
    const title = data.name || data.product_name || data.title || "Produit";
    const brand = data.brand || data.brands || "—";
    const image = data.image_url || data.image || data.thumbnail || null;
    $t('[data-role="title"]').textContent = title;
    $t('[data-role="brand"]').textContent = brand;
    if(image){
      const img = new Image();
      img.alt = title; img.loading = "lazy";
      img.style.width="100%"; img.style.height="120px"; img.style.objectFit="contain"; img.style.borderRadius="10px";
      img.src = image; th.replaceWith(img);
    }else{
      th.textContent = "Pas d’image";
    }
    // re-appliquer le filtre/surbrillance après hydratation des textes
    applyFilter();
  }

  // ===== Calculs + tri/rang =====
  async function refreshCompare(force=false){
    if(!eans.length) return;
    if(!force && Object.keys(compareCache).length && eans.every(e=>compareCache[e])){
      sortCards(); paintRanks(); return;
    }
    let table=null;
    try{
      const url = `/compare?eans=${encodeURIComponent(eans.join(','))}`;
      const r = await fetch(url);
      if(r.ok){ table = await r.json(); }
    }catch(e){ table=null; }

    const byEan = {};
    if(Array.isArray(table)){
      for(const row of table){
        const ean = (row.ean || row.code || row.id || "").toString();
        const fp = pickFootprint(row);
        if(ean && fp!=null && !isNaN(fp)){ byEan[ean] = Number(fp); }
      }
    }

    const vals = Object.values(byEan);
    const min = vals.length ? Math.min(...vals) : 0;
    const max = vals.length ? Math.max(...vals) : 1;
    const span = Math.max(1e-9, max - min);

    compareCache = {};
    for(const e of eans){
      if(byEan[e]!=null){
        const raw = byEan[e];
        const norm = (raw - min)/span; // 0 meilleur → 1 pire
        compareCache[e] = { raw, norm };
      }
    }

    document.querySelectorAll('.card').forEach(card=>{
      const ean = card.dataset.ean;
      const bar = card.querySelector('[data-role="bar"]');
      const dot = card.querySelector('[data-role="dot"]');
      const lab = card.querySelector('[data-role="fp-label"]');
      const glb = card.querySelector('[data-role="glabel"]');
      if(!compareCache[ean]){
        bar.style.width='0%'; dot.style.background='#bbb'; lab.textContent='Empreinte : —'; glb.textContent='—';
        return;
      }
      const {raw, norm} = compareCache[ean];
      const pct = Math.round(norm*100);
      bar.style.width = Math.max(6,pct)+'%';
      dot.style.background = mixColor('#2e7d32','#F5C147', norm);
      lab.textContent = `Empreinte : ${fmt(raw)}`;
      glb.textContent = (pct<=25?'Très faible':pct<=50?'Faible':pct<=75?'Moyenne':'Élevée');
    });

    sortCards(); paintRanks();
  }

  function sortCards(){
    const cards = Array.from(document.querySelectorAll('.card'));
    const sort = prefs.sort || 'best';
    const order = (prefs.order === 'desc') ? -1 : 1; // asc=1, desc=-1
    const tiebreak = prefs.tiebreak || 'name';
    const collator = new Intl.Collator('fr',{sensitivity:'base',numeric:true});

    const items = cards.map(c=>{
      const ean = c.dataset.ean;
      const title = (c.querySelector('[data-role="title"]')?.textContent||'').trim();
      const brand = (c.querySelector('[data-role="brand"]')?.textContent||'').trim();
      const fp = compareCache[ean]?.raw;
      const norm = compareCache[ean]?.norm;
      return {el:c, ean, title, brand, fp, norm};
    });

    const cmpText = (a,b,field)=>{
      const A = (field==='ean') ? a.ean : (field==='brand' ? a.brand||'' : a.title||'');
      const B = (field==='ean') ? b.ean : (field==='brand' ? b.brand||'' : b.title||'');
      return collator.compare(A, B);
    };

    items.sort((a,b)=>{
      if (sort==='best' || sort==='worst'){
        const dir = (sort==='best') ? 1 : -1;
        const A = (a.norm==null) ? Infinity : a.norm;
        const B = (b.norm==null) ? Infinity : b.norm;
        if (A !== B) return dir * (A - B);
        const Afp = (a.fp==null) ? Infinity : a.fp;
        const Bfp = (b.fp==null) ? Infinity : b.fp;
        if (Afp !== Bfp) return dir * (Afp - Bfp);
        const t = cmpText(a,b,tiebreak);
        if (t !== 0) return t;
        return collator.compare(a.ean, b.ean);
      }
      if (sort==='brand'){
        const r = cmpText(a,b,'brand'); if (r!==0) return order*r;
        const r2 = cmpText(a,b,'name'); if (r2!==0) return order*r2;
        return order*collator.compare(a.ean, b.ean);
      }
      if (sort==='name'){
        const r = cmpText(a,b,'name'); if (r!==0) return order*r;
        const r2 = cmpText(a,b,'brand'); if (r2!==0) return order*r2;
        return order*collator.compare(a.ean, b.ean);
      }
      if (sort==='ean'){
        return order*collator.compare(a.ean, b.ean);
      }
      return 0;
    });

    items.forEach(i=>track.appendChild(i.el));
  }

  function paintRanks(){
    const show = !!prefs.showRank;
    const cards = Array.from(document.querySelectorAll('.card'));
    cards.forEach((c,idx)=>{
      const rk = c.querySelector('[data-role="rank"]');
      rk.textContent = `#${idx+1}`;
      rk.classList.toggle('show', show);
      rk.style.background = idx===0 ? '#2e7d32' : '#111';
    });
  }

  // ---- Helpers
  // A9 — import enrichi depuis l’URL (inclut tri/ordre/départage/filtre)
  function importFromUrl(){
    const params = new URLSearchParams(location.search);

    // EANs
    const csv = (params.get("eans")||"").trim();
    let added=0;
    if(csv){
      const list = csv.split(",").map(s=>s.trim()).filter(Boolean);
      list.forEach(v=> { if(addEAN(v,true)) added++; });
    }

    // Préférences : sort, rank, order, tiebreak, filter
    const incoming = {
      sort: params.get("sort"),
      rank: params.get("rank"),
      order: params.get("order"),
      tiebreak: params.get("tiebreak"),
      filter: params.get("filter"),
    };

    let changed = false;

    if(incoming.sort && incoming.sort !== prefs.sort){ prefs.sort = incoming.sort; changed = true; }
    if(incoming.rank!=null){
      const val = incoming.rank === "1" || incoming.rank === "true";
      if(val !== !!prefs.showRank){ prefs.showRank = val; changed = true; }
    }
    if(incoming.order && incoming.order !== prefs.order){ prefs.order = incoming.order; changed = true; }
    if(incoming.tiebreak && incoming.tiebreak !== prefs.tiebreak){ prefs.tiebreak = incoming.tiebreak; changed = true; }
    if(typeof incoming.filter === "string"){
      const q = (incoming.filter||"").trim();
      if(q !== (prefs.filter||"")){ prefs.filter = q; changed = true; }
    }

    // Répercuter dans l’UI
    if(changed){
      savePrefs();
      if(sortSelect && prefs.sort) sortSelect.value = prefs.sort;
      if(toggleRank) toggleRank.checked = !!prefs.showRank;
      if(orderSelect && prefs.order) orderSelect.value = prefs.order;
      if(tiebreakSelect && prefs.tiebreak) tiebreakSelect.value = prefs.tiebreak;
      if(searchInput && typeof prefs.filter === "string") searchInput.value = prefs.filter;
    }

    if(added>0){ saveEans(); render(); notify(`${added} EAN importé(s).`); }
    else if(!changed){ notify("Aucun paramètre nouveau à importer."); }

    // Toujours recalculer/synchroniser l’affichage
    updateCounter();
    refreshCompare(true);
    applyFilter();
    sortCards();
    paintRanks();
    syncUrlState();   // <— sync à la fin, une seule fois
  }

  function pickFootprint(row){
    const map = {}; for(const k of Object.keys(row)){ map[k.toLowerCase()] = k; }
    const candidates = ['footprint','co2e','co2eq','carbon','ghg','score','value'];
    for(const c of candidates){ if(map[c]) return toNumber(row[map[c]]); }
    return null;
  }
  function toNumber(v){
    if(v==null) return null;
    if(typeof v === 'number') return v;
    const s = String(v).replace(',', '.').replace(/[^\d.\-eE]/g,'');
    const n = parseFloat(s); return isNaN(n) ? null : n;
  }
  function fmt(v){
    if(v>=1000) return (v/1000).toFixed(2)+'k';
    if(v>=100) return v.toFixed(0);
    if(v>=10) return v.toFixed(1);
    return v.toFixed(2);
  }
  function mixColor(hexA, hexB, t){
    const a = hexToRgb(hexA), b = hexToRgb(hexB);
    const m = {r:Math.round(a.r+(b.r-a.r)*t), g:Math.round(a.g+(b.g-a.g)*t), b:Math.round(a.b+(b.b-a.b)*t)};
    return `rgb(${m.r},${m.g},${m.b})`;
  }
  function hexToRgb(h){
    const x = h.replace('#','');
    const n = parseInt(x.length===3 ? x.split('').map(c=>c+c).join('') : x, 16);
    return {r:(n>>16)&255, g:(n>>8)&255, b:(n)&255};
  }
  function notify(msg){
    toast.textContent = msg; toast.style.opacity=1;
    setTimeout(()=>toast.style.opacity=0, 1400);
  }

  // A5 — helpers partage + A9 (état complet)
  function buildShareUrl(full=false){
    const base = location.origin + location.pathname;
    const params = new URLSearchParams();

    if(eans.length) params.set("eans", eans.join(","));
    if(prefs?.sort) params.set("sort", prefs.sort);
    if(typeof prefs?.showRank === "boolean") params.set("rank", prefs.showRank ? "1" : "0");

    if(full){
      if(prefs?.order) params.set("order", prefs.order);
      if(prefs?.tiebreak) params.set("tiebreak", prefs.tiebreak);
      if(prefs?.filter){ const q=(prefs.filter||"").trim(); if(q) params.set("filter", q); }
    }

    const qs = params.toString();
    return qs ? `${base}?${qs}` : base;
  }

  // A7 — filtre & surbrillance
  function normalize(s) { return (s||"").toString().toLowerCase(); }
  function highlightText(el, text, q) {
    if (!q) { el.innerHTML = escapeHtml(text); return; }
    const t = text || "";
    const idx = t.toLowerCase().indexOf(q.toLowerCase());
    if (idx < 0) { el.innerHTML = escapeHtml(t); return; }
    const before = escapeHtml(t.slice(0, idx));
    const match  = escapeHtml(t.slice(idx, idx + q.length));
    const after  = escapeHtml(t.slice(idx + q.length));
    el.innerHTML = `${before}<mark>${match}</mark>${after}`;
  }
  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, m => (
      m === '&' ? '&amp;' :
      m === '<' ? '&lt;'  :
      m === '>' ? '&gt;'  :
      m === '"' ? '&quot;': '&#39;'
    ));
  }
  function applyFilter() {
    const q = (prefs.filter || "").trim();
    const cards = Array.from(document.querySelectorAll('.card'));
    let visible = 0;

    for (const c of cards) {
      const ean = c.dataset.ean || "";
      const titleEl = c.querySelector('[data-role="title"]');
      const brandEl = c.querySelector('[data-role="brand"]');

      const title = (titleEl?.textContent || "").trim();
      const brand = (brandEl?.textContent || "").trim();
      const hay = `${title} ${brand} ${ean}`;

      const match = !q || normalize(hay).includes(normalize(q));
      c.style.display = match ? "" : "none";
      if (match) visible++;

      if (match) {
        if (titleEl) highlightText(titleEl, title, q);
        if (brandEl) highlightText(brandEl, brand, q);
      } else {
        if (titleEl) titleEl.innerHTML = escapeHtml(title);
        if (brandEl) brandEl.innerHTML = escapeHtml(brand);
      }
    }

    const empty = document.querySelector('.tracks .empty');
    if (cards.length && visible === 0) {
      if (!empty) {
        const d = document.createElement("div");
        d.className = "empty";
        d.textContent = "Aucun résultat pour ce filtre.";
        document.querySelector('.tracks')?.appendChild(d);
      } else {
        empty.textContent = "Aucun résultat pour ce filtre.";
        empty.style.display = "";
      }
    } else if (empty) {
      empty.style.display = "none";
    }
  }

  // A6/A7 — compteur (prend en compte le filtre actif)
  function updateCounter() {
    const hasFilter = !!(prefs.filter && prefs.filter.trim());
    const cards = Array.from(document.querySelectorAll('.card'));
    const visible = cards.filter(c => c.style.display !== 'none').length;

    const n = hasFilter ? visible : eans.length;
    if (counter) {
      counter.textContent = `${n} ${n > 1 ? "articles" : "article"}`;
    }
  }
</script>
<script>
/* ============================================================================
   A11 — Historique des comparaisons (Étape 1 : stockage auto de la session)
   - Non intrusif : écoute des changements d’URL + événement custom optionnel
   - Clair et commenté en FR
   - Rétro-compatible (aucune dépendance CSS/HTML)
   ============================================================================ */

/** Clé localStorage dédiée à l'historique */
const HONOUA_HISTORY_KEY = 'honoua_compare_history_v1';

/** Paramètres : adapte si besoin le nom des query params utilisés par A8–A10 */
const HISTORY_MAX_ENTRIES = 50; // borne de sécurité
const URL_PARAM_EANS       = 'eans';   // e.g. "123,456,789"
const URL_PARAM_SORT       = 'sort';   // e.g. "score" | "name" | ...
const URL_PARAM_ORDER      = 'order';  // e.g. "asc" | "desc"
const URL_PARAM_FILTERS    = 'filters';// e.g. "vegan,local" (ou JSON encodé)
const URL_PARAM_QUERY      = 'q';      // optionnel : mot-clé / recherche

/** Utilitaire sûr : lecture JSON dans localStorage */
function lsReadJSON(key, fallback) {
  try {
    const raw = localStorage.getItem(key);
    return raw ? JSON.parse(raw) : fallback;
  } catch (e) {
    console.warn('[A11] Lecture JSON LS échouée:', e);
    return fallback;
  }
}

/** Utilitaire sûr : écriture JSON dans localStorage */
function lsWriteJSON(key, value) {
  try {
    localStorage.setItem(key, JSON.stringify(value));
  } catch (e) {
    console.warn('[A11] Écriture JSON LS échouée:', e);
  }
}

/** Parse l'état courant depuis l'URL (source de vérité depuis A8–A10) */
function getCompareStateFromURL() {
  const u = new URL(window.location.href);
  const p = u.searchParams;

  const rawEans   = (p.get(URL_PARAM_EANS) || '').trim();
  const eans      = rawEans ? rawEans.split(',').map(s => s.trim()).filter(Boolean) : [];

  const sort      = (p.get(URL_PARAM_SORT)  || '').trim() || null;
  const order     = (p.get(URL_PARAM_ORDER) || '').trim() || null;
  const query     = (p.get(URL_PARAM_QUERY) || '').trim() || null;

  // Filtres : laisse souple; si c'est un CSV => array ; si JSON encodé => objet
  let filtersRaw  = (p.get(URL_PARAM_FILTERS) || '').trim();
  let filters     = null;
  if (filtersRaw) {
    try {
      // Essaye de décoder du JSON si ça ressemble à du JSON
      if (filtersRaw.startsWith('{') || filtersRaw.startsWith('[')) {
        filters = JSON.parse(filtersRaw);
      } else {
        // sinon CSV => tableau
        filters = filtersRaw.split(',').map(s => s.trim()).filter(Boolean);
      }
    } catch {
      // fallback brut : on conserve la chaîne
      filters = filtersRaw;
    }
  }

  return {
    eans,
    sort,
    order,
    filters,
    query,
    // On garde l’URL complète pour restauration/affichage ultérieur
    url: u.toString()
  };
}

/** Crée un enregistrement "session" prêt pour l'historique */
function buildHistoryEntryFromState(state) {
  const now = new Date();
  return {
    id: now.getTime(),               // identifiant simple (timestamp)
    ts: now.toISOString(),           // ISO pour affichage futur
    productCount: state.eans.length, // nombre de produits
    params: {
      eans: state.eans,
      sort: state.sort,
      order: state.order,
      filters: state.filters,
      query: state.query
    },
    url: state.url
  };
}

/** Compare deux sessions (pour déduplication basique) */
function shallowEqualSession(a, b) {
  if (!a || !b) return false;
  const A = a.params, B = b.params;
  try {
    return JSON.stringify(A) === JSON.stringify(B);
  } catch {
    return false;
  }
}

/** Enregistre la session courante dans l'historique (avec dédup + borne) */
function saveCurrentSessionToHistory() {
  const state   = getCompareStateFromURL();
  const entry   = buildHistoryEntryFromState(state);
  const history = lsReadJSON(HONOUA_HISTORY_KEY, []);

  // déduplication: si la dernière entrée a le même état, on ne pousse pas
  const last = history[history.length - 1];
  if (shallowEqualSession(last, entry)) {
    // Rien à faire — on ne spam pas l'historique
    return;
  }

  history.push(entry);

  // borne de sécurité
  if (history.length > HISTORY_MAX_ENTRIES) {
    history.splice(0, history.length - HISTORY_MAX_ENTRIES);
  }

  lsWriteJSON(HONOUA_HISTORY_KEY, history);
  // (Étape 2 utilisera cette base pour l’affichage de la liste + bouton "Recharger")
}

/* ------------------------------
   Déclencheurs d’enregistrement
   ------------------------------
   1) Changements d’URL (pushState / replaceState / popstate) — car A8–A10
      synchronisent l’état via l’URL.
   2) Événement personnalisé "honoua:compare:updated" — que tu peux
      déclencher à la fin de ton cycle de rendu si nécessaire.
*/

// Patch léger pour émettre un event quand pushState/replaceState sont appelés
(function patchHistoryMethods(){
  const _pushState    = history.pushState;
  const _replaceState = history.replaceState;

  function emitURLChanged() {
    // On enregistre en léger différé pour laisser l'URL se stabiliser
    clearTimeout(emitURLChanged._t);
    emitURLChanged._t = setTimeout(saveCurrentSessionToHistory, 50);
  }

  history.pushState = function() {
    const r = _pushState.apply(this, arguments);
    window.dispatchEvent(new Event('honoua:urlchange'));
    emitURLChanged();
    return r;
  };
  history.replaceState = function() {
    const r = _replaceState.apply(this, arguments);
    window.dispatchEvent(new Event('honoua:urlchange'));
    emitURLChanged();
    return r;
  };

  window.addEventListener('popstate', emitURLChanged);
  window.addEventListener('honoua:urlchange', emitURLChanged);
})();

// Écoute d’un éventuel événement applicatif (optionnel mais pratique)
window.addEventListener('honoua:compare:updated', () => {
  // debounce léger pour éviter d’écrire trop souvent
  clearTimeout(window.__honouaHistoryDebounce__);
  window.__honouaHistoryDebounce__ = setTimeout(saveCurrentSessionToHistory, 100);
});

// Premier snapshot au chargement si l'URL contient déjà un état
document.addEventListener('DOMContentLoaded', () => {
  saveCurrentSessionToHistory();
});
</script>
<script>
/* ============================================================================
   A11 — Historique des comparaisons (Étape 2)
   - Affiche la liste des sessions sauvegardées (date, nb produits)
   - Bouton "Recharger" pour restaurer une session (navigation vers l'URL)
   - Aucun style imposé, rétro-compatible
   ============================================================================ */

(function(){
  // --- Constantes & utilitaires (sans redéclarer celles de l'Étape 1) -------
  var HISTORY_KEY = 'honoua_compare_history_v1';
  var $section = null, $list = null;

  function lsReadJSON(key, fallback) {
    try {
      var raw = localStorage.getItem(key);
      return raw ? JSON.parse(raw) : fallback;
    } catch (e) {
      console.warn('[A11:E2] Lecture JSON LS échouée:', e);
      return fallback;
    }
  }

  function formatDateTime(tsISO) {
    // Affichage local FR court : 17/10/2025 14:32
    try {
      var d = new Date(tsISO);
      return d.toLocaleString('fr-FR', {
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit'
      });
    } catch {
      return tsISO;
    }
  }

  function pluralizeProduit(n) {
    return n + ' produit' + (n > 1 ? 's' : '');
  }

  // --- Rendu de la liste -----------------------------------------------------
  function renderHistory() {
    if (!$section || !$list) return;

    var history = lsReadJSON(HISTORY_KEY, []);

    // Afficher/masquer la section selon contenu
    $section.hidden = !history || history.length === 0;

    // Vider la liste
    $list.innerHTML = '';

    if (!history || history.length === 0) {
      // Message simple, style minimaliste
      var empty = document.createElement('p');
      empty.textContent = 'Aucun historique pour le moment.';
      $list.appendChild(empty);
      return;
    }

    // On affiche du plus récent au plus ancien
    var items = history.slice().reverse();

 // … (le reste du code Étape 3 inchangé au-dessus)

function render() {
  if (!$section || !$list || !$bar) return;

  pruneIfNeeded();
  var history = readHistory();
  var showPinnedOnly = !!($chkPinnedOnly && $chkPinnedOnly.checked);

  var hasItems = history.length > 0;
  $section.hidden = !hasItems;
  $bar.hidden = !hasItems;

  $list.innerHTML = '';
  if (!hasItems) {
    var empty = document.createElement('p');
    empty.textContent = 'Aucun historique pour le moment.';
    $list.appendChild(empty);
    return;
  }

  // État courant depuis l’URL (fonction dispo en Étape 1)
  var currentState = (typeof getCompareStateFromURL === 'function') ? getCompareStateFromURL() : null;
  function isCurrent(entry){
    if (!currentState || !entry || !entry.params) return false;
    try {
      // Comparaison des paramètres principaux ; ajuste si tu ajoutes d’autres clés
      return JSON.stringify(entry.params) === JSON.stringify({
        eans:   currentState.eans,
        sort:   currentState.sort,
        order:  currentState.order,
        filters:currentState.filters,
        query:  currentState.query
      });
    } catch { return false; }
  }

  var items = history.slice().reverse();
  if (showPinnedOnly) items = items.filter(function(e){ return e.pinned; });

  if (items.length === 0) {
    var none = document.createElement('p');
    none.textContent = 'Aucun élément épinglé.';
    $list.appendChild(none);
    return;
  }

  items.forEach(function(entry){
    var item = document.createElement('div');
    item.setAttribute('role','listitem');
    item.className = 'history-item';

    var current = isCurrent(entry);                  // [NOUVEAU]
    item.classList.toggle('is-pinned', !!entry.pinned);
    item.classList.toggle('is-current', !!current);  // [NOUVEAU]

    var meta = document.createElement('div');
    meta.className = 'history-meta';

    // [NOUVEAU] — Pastille d’état
    var dot = document.createElement('span');
    dot.className = 'history-dot';
    dot.setAttribute('aria-hidden','true');

    // Ligne principale (pastille + date + nb produits + badges)
    var row1 = document.createElement('div');
    row1.className = 'meta-row';

    var time = document.createElement('time');
    time.setAttribute('datetime', entry.ts);
    time.textContent = formatDateTime(entry.ts);

    var count = document.createElement('span');
    count.className = 'history-count';
    count.textContent = ' • ' + pluralizeProduit(entry.productCount);

    row1.appendChild(dot);
    row1.appendChild(time);
    row1.appendChild(count);

    // Badge “Épinglé” (si épinglé) — déjà implémenté auparavant
    if (entry.pinned) {
      var badgePinned = document.createElement('span');
      badgePinned.className = 'history-badge';
      badgePinned.textContent = 'Épinglé';
      row1.appendChild(badgePinned);
    }

    // [NOUVEAU] — Badge “Actuelle”
    if (current) {
      var badgeCurrent = document.createElement('span');
      badgeCurrent.className = 'history-badge-current';
      badgeCurrent.textContent = 'Actuelle';
      row1.appendChild(badgeCurrent);
    }

    // [NOUVEAU] — Ligne des chips (tri/ordre/filtre/query)
    var row2 = document.createElement('div');
    row2.className = 'history-chips';

    var p = entry.params || {};
    if (p.sort) {
      var c1 = document.createElement('span');
      c1.className = 'chip chip-sort';
      c1.textContent = 'Tri: ' + p.sort;
      row2.appendChild(c1);
    }
    if (p.order) {
      var c2 = document.createElement('span');
      c2.className = 'chip chip-order';
      c2.textContent = 'Ordre: ' + (p.order === 'desc' ? '↓ desc' : '↑ asc');
      row2.appendChild(c2);
    }
    if (p.filters && (Array.isArray(p.filters) ? p.filters.length : String(p.filters).length)) {
      var countFilters = Array.isArray(p.filters) ? p.filters.length : 1;
      var c3 = document.createElement('span');
      c3.className = 'chip chip-filter';
      c3.textContent = 'Filtres: ' + countFilters;
      c3.title = Array.isArray(p.filters) ? p.filters.join(', ') : String(p.filters);
      row2.appendChild(c3);
    }
    if (p.query) {
      var c4 = document.createElement('span');
      c4.className = 'chip chip-query';
      c4.textContent = 'Recherche: "' + p.query + '"';
      row2.appendChild(c4);
    }

    meta.appendChild(row1);
    if (row2.childElementCount > 0) meta.appendChild(row2);

    // Actions
    var actions = document.createElement('div');
    actions.className = 'history-actions';

    var btnReload = document.createElement('button');
    btnReload.type = 'button';
    btnReload.className = 'history-reload';
    btnReload.textContent = 'Recharger';
    btnReload.addEventListener('click', function(){
      if (!entry || !entry.url) return;
      window.location.href = entry.url;
    });

    var btnPin = document.createElement('button');
    btnPin.type = 'button';
    btnPin.className = 'history-pin';
    btnPin.textContent = entry.pinned ? 'Désépingler' : 'Épingler';
    btnPin.setAttribute('aria-pressed', String(!!entry.pinned));
    btnPin.addEventListener('click', function(){ togglePin(entry.id); });

    var btnDelete = document.createElement('button');
    btnDelete.type = 'button';
    btnDelete.className = 'history-delete';
    btnDelete.textContent = 'Supprimer';
    btnDelete.addEventListener('click', function(){
      if (confirm('Supprimer cette entrée ?')) deleteEntry(entry.id);
    });

    actions.appendChild(btnReload);
    actions.appendChild(btnPin);
    actions.appendChild(btnDelete);

    item.appendChild(meta);
    item.appendChild(actions);
    $list.appendChild(item);
  });
}

// … (le reste du code Étape 3 inchangé en dessous)

  // --- Synchronisation avec les changements d'état ---------------------------
  // On re-render quand:
  //  - l’URL change (A8–A10)
  //  - l’app émet "honoua:compare:updated" (si tu l’utilises)
  //  - un autre onglet modifie le localStorage (événement "storage")

  function requestRender() {
    clearTimeout(requestRender._t);
    requestRender._t = setTimeout(renderHistory, 50);
  }

  window.addEventListener('honoua:urlchange', requestRender);
  window.addEventListener('honoua:compare:updated', requestRender);
  window.addEventListener('storage', function(ev){
    if (ev && ev.key === HISTORY_KEY) requestRender();
  });

  // --- Boot ------------------------------------------------------------------
  document.addEventListener('DOMContentLoaded', function(){
    $section = document.getElementById('compare-history');
    $list    = document.getElementById('compare-history-list');
    if (!$section || !$list) return;
    renderHistory();
  });
})();
</script>
<script>
/* ============================================================================
   A11 — Historique des comparaisons (Étape 3 : actions)
   - Vider l’historique
   - Épingler / Désépingler une session
   - Supprimer une entrée
   - Respect de la borne max en préservant les entrées épinglées
   ============================================================================ */

(function(){
  var HISTORY_KEY = 'honoua_compare_history_v1';
  var HISTORY_MAX_ENTRIES = 50; // même borne que l’Étape 1

  var $section, $list, $bar, $btnClear, $chkPinnedOnly;

  // -------- LS utils --------
  function readHistory() {
    try {
      var raw = localStorage.getItem(HISTORY_KEY);
      var arr = raw ? JSON.parse(raw) : [];
      // Migration douce : ajoute pinned=false si absent
      arr.forEach(function(e){ if (typeof e.pinned !== 'boolean') e.pinned = false; });
      return arr;
    } catch(e){
      console.warn('[A11:E3] readHistory:', e);
      return [];
    }
  }
  function writeHistory(arr) {
    try {
      localStorage.setItem(HISTORY_KEY, JSON.stringify(arr));
      window.dispatchEvent(new StorageEvent('storage', {key: HISTORY_KEY})); // notifie local
    } catch(e){
      console.warn('[A11:E3] writeHistory:', e);
    }
  }

  // -------- Actions --------
  function clearHistory() {
    if (!confirm('Confirmer la suppression de tout l’historique ?')) return;
    writeHistory([]);
    render();
  }

  function togglePin(id) {
    var h = readHistory();
    var i = h.findIndex(function(e){ return e.id === id; });
    if (i === -1) return;
    h[i].pinned = !h[i].pinned;
    writeHistory(h);
    render();
  }

  function deleteEntry(id) {
    var h = readHistory();
    var i = h.findIndex(function(e){ return e.id === id; });
    if (i === -1) return;
    h.splice(i,1);
    writeHistory(h);
    render();
  }

  // Coupe en respectant les épinglés
  function pruneIfNeeded() {
    var h = readHistory();
    if (h.length <= HISTORY_MAX_ENTRIES) return;
    // Conserve tous les épinglés, puis les plus récents non épinglés
    var pinned = h.filter(function(e){ return e.pinned; });
    var others = h.filter(function(e){ return !e.pinned; });
    // On garde autant de "others" que possible (en fin = plus récents car on pousse en fin)
    var keepOthers = Math.max(0, HISTORY_MAX_ENTRIES - pinned.length);
    if (others.length > keepOthers) {
      others = others.slice(others.length - keepOthers);
    }
    // Recompose dans l’ordre chronologique initial
    var kept = h.filter(function(e){
      return pinned.includes(e) || others.includes(e);
    });
    writeHistory(kept);
  }

  // -------- Rendu (étend le rendu Étape 2 sans le casser) --------
  function formatDateTime(tsISO) {
    try {
      var d = new Date(tsISO);
      return d.toLocaleString('fr-FR', {
        year:'numeric', month:'2-digit', day:'2-digit',
        hour:'2-digit', minute:'2-digit'
      });
    } catch { return tsISO; }
  }
  function pluralizeProduit(n) {
    return n + ' produit' + (n>1?'s':'');
  }

  function render() {
    if (!$section || !$list || !$bar) return;

    pruneIfNeeded(); // garantit la borne avec respect des épinglés
    var history = readHistory();
    var showPinnedOnly = !!($chkPinnedOnly && $chkPinnedOnly.checked);

    // Visibilités
    var hasItems = history.length > 0;
    $section.hidden = !hasItems;
    $bar.hidden = !hasItems;

    // Vide liste
    $list.innerHTML = '';

    if (!hasItems) {
      var empty = document.createElement('p');
      empty.textContent = 'Aucun historique pour le moment.';
      $list.appendChild(empty);
      return;
    }

    // Plus récent → plus ancien
    var items = history.slice().reverse();
    if (showPinnedOnly) items = items.filter(function(e){ return e.pinned; });

    if (items.length === 0) {
      var none = document.createElement('p');
      none.textContent = 'Aucun élément épinglé.';
      $list.appendChild(none);
      return;
    }

    items.forEach(function(entry){
      var item = document.createElement('div');
      item.setAttribute('role','listitem');
      item.className = 'history-item';

      var meta = document.createElement('div');
      meta.className = 'history-meta';

      var time = document.createElement('time');
      time.setAttribute('datetime', entry.ts);
      time.textContent = formatDateTime(entry.ts);

      var count = document.createElement('span');
      count.className = 'history-count';
      count.textContent = ' • ' + pluralizeProduit(entry.productCount);

      meta.appendChild(time);
      meta.appendChild(count);

      var actions = document.createElement('div');
      actions.className = 'history-actions';

      // Recharger (déjà présent Étape 2 — on le remet ici de façon autonome)
      var btnReload = document.createElement('button');
      btnReload.type = 'button';
      btnReload.className = 'history-reload';
      btnReload.textContent = 'Recharger';
      btnReload.addEventListener('click', function(){
        if (!entry || !entry.url) return;
        window.location.href = entry.url;
      });

      // Épingler
      var btnPin = document.createElement('button');
      btnPin.type = 'button';
      btnPin.className = 'history-pin';
      btnPin.textContent = entry.pinned ? 'Désépingler' : 'Épingler';
      btnPin.addEventListener('click', function(){ togglePin(entry.id); });

      // Supprimer
      var btnDelete = document.createElement('button');
      btnDelete.type = 'button';
      btnDelete.className = 'history-delete';
      btnDelete.textContent = 'Supprimer';
      btnDelete.addEventListener('click', function(){
        if (confirm('Supprimer cette entrée ?')) deleteEntry(entry.id);
      });

      actions.appendChild(btnReload);
      actions.appendChild(btnPin);
      actions.appendChild(btnDelete);




      item.appendChild(meta);
      item.appendChild(actions);

      $list.appendChild(item);
    });
  }

  // -------- Sync évènements --------
  function requestRender(){ clearTimeout(requestRender._t); requestRender._t = setTimeout(render, 50); }
  window.addEventListener('honoua:urlchange', requestRender);
  window.addEventListener('honoua:compare:updated', requestRender);
  window.addEventListener('storage', function(ev){ if (!ev || ev.key === HISTORY_KEY) requestRender(); });

  // -------- Boot --------
  document.addEventListener('DOMContentLoaded', function(){
    $section      = document.getElementById('compare-history');
    $list         = document.getElementById('compare-history-list');
    $bar          = document.getElementById('compare-history-actions');
    $btnClear     = document.getElementById('history-clear');
    $chkPinnedOnly= document.getElementById('history-show-pinned');

    if (!$section || !$list || !$bar) return;

    if ($btnClear)     $btnClear.addEventListener('click', clearHistory);
    if ($chkPinnedOnly)$chkPinnedOnly.addEventListener('change', render);

    render();
  });
})();

// A17 — utilitaire toast
function showToast(msg){
  var el = document.getElementById('history-toast');
  if (!el) { alert(msg); return; }
  el.textContent = msg;
  el.hidden = false;
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=>{ el.hidden = true; }, 1400);
}



function render() {
  // … (début de render, inchangé)

  items.forEach(function(entry){
    var item = document.createElement('div');
    item.setAttribute('role','listitem');
    item.className = 'history-item';

    // [NOUVEAU] — État visuel si épinglé
    item.classList.toggle('is-pinned', !!entry.pinned); // ajoute la classe

    var meta = document.createElement('div');
    meta.className = 'history-meta';

    var time = document.createElement('time');
    time.setAttribute('datetime', entry.ts);
    time.textContent = formatDateTime(entry.ts);

    var count = document.createElement('span');
    count.className = 'history-count';
    count.textContent = ' • ' + pluralizeProduit(entry.productCount);

    meta.appendChild(time);
    meta.appendChild(count);

    // [NOUVEAU] — Mini-badge “Épinglé”
    if (entry.pinned) {
      var badge = document.createElement('span');
      badge.className = 'history-badge';    // style minimal (voir CSS ci-dessous)
      badge.textContent = 'Épinglé';
      meta.appendChild(badge);
    }

    var actions = document.createElement('div');
    actions.className = 'history-actions';

    var btnReload = document.createElement('button');
    btnReload.type = 'button';
    btnReload.className = 'history-reload';
    btnReload.textContent = 'Recharger';
    btnReload.addEventListener('click', function(){
      if (!entry || !entry.url) return;
      window.location.href = entry.url;
    });

    var btnPin = document.createElement('button');
    btnPin.type = 'button';
    btnPin.className = 'history-pin';
    btnPin.textContent = entry.pinned ? 'Désépingler' : 'Épingler';

    // [NOUVEAU] — Accessibilité: indique l’état
    btnPin.setAttribute('aria-pressed', String(!!entry.pinned));

    btnPin.addEventListener('click', function(){ togglePin(entry.id); });

    var btnDelete = document.createElement('button');
    btnDelete.type = 'button';
    btnDelete.className = 'history-delete';
    btnDelete.textContent = 'Supprimer';
    btnDelete.addEventListener('click', function(){
      if (confirm('Supprimer cette entrée ?')) deleteEntry(entry.id);
    });

    
/* ============================================================================
   A17 — Copier l’URL de session + toast
   ============================================================================ */
(function(){
  var TOAST_MS = 1400; // durée d’affichage

  function showToast(msg){
    var el = document.getElementById('history-toast');
    if (!el) return alert(msg);
    el.textContent = msg;
    el.hidden = false;
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=>{ el.hidden = true; }, TOAST_MS);
  }

  // Patch léger: ajoute le bouton "Copier" au rendu existant (Étape 3)
  // -> Cherche une fonction render() dans le scope précédent
  // Si elle n'est pas accessible, on ajoute dynamiquement le bouton au vol après chaque render.
  // Ici, on monkey-patche appendChild sur la liste pour insérer le bouton.
  document.addEventListener('DOMContentLoaded', function(){
    var $list = document.getElementById('compare-history-list');
    if (!$list) return;

    // MutationObserver pour injecter "Copier" à chaque item rendu/refraîchi
    var obs = new MutationObserver(function(muts){
      muts.forEach(function(m){
        m.addedNodes.forEach(function(node){
          if (!(node instanceof HTMLElement)) return;
          if (!node.classList.contains('history-item')) return;

          // Trouve le conteneur des actions déjà existant
          var actions = node.querySelector('.history-actions');
          if (!actions) return;

          // Crée le bouton “Copier”
          var btnCopy = document.createElement('button');
          btnCopy.type = 'button';
          btnCopy.className = 'history-copy';
          btnCopy.textContent = 'Copier l’URL';

          // URL à copier depuis l'entrée; elle est stockée côté données dans A11
          // On la retrouve via l’attribut data-url si présent, sinon via le dernier état injecté.
          // Plus simple: on parcourt l’historique à partir de l’horodatage affiché.
          // → On stocke l’URL sur l’élément pour fiabilité (ajout custom ici).
          // Si déjà présent, ne pas dupliquer
          if (!node.dataset.url && window.localStorage){
            try{
              var history = JSON.parse(localStorage.getItem('honoua_compare_history_v1')) || [];
              // heuristique : on recompose avec time[datetime]
              var time = node.querySelector('time');
              if (time && time.dateTime){
                var entry = history.find(e => e.ts === time.dateTime);
                if (entry && entry.url) node.dataset.url = entry.url;
              }
            }catch{}
          }

          btnCopy.addEventListener('click', async function(){
            var url = node.dataset.url || window.location.href;
            try{
              await navigator.clipboard.writeText(url);
              showToast('Lien copié ✅');
            }catch(e){
              // Fallback si clipboard indisponible
              var ta = document.createElement('textarea');
              ta.value = url; document.body.appendChild(ta);
              ta.select(); document.execCommand('copy');
              ta.remove();
              showToast('Lien copié ✅');
            }
          });

          actions.appendChild(btnCopy);
        });
      });
    });

    obs.observe($list, { childList:true });
  });
})();



    actions.appendChild(btnReload);
    actions.appendChild(btnPin);
    actions.appendChild(btnDelete);

    item.appendChild(meta);
    item.appendChild(actions);
    $list.appendChild(item);
  });
}
// … (fin code Étape 3)

// Met en pause automatiquement si l’URL contient ?histpause=1
document.addEventListener('DOMContentLoaded', () => {
  const p = new URL(location.href).searchParams;
  if (p.get('histpause') === '1') {
    window.__honouaHistoryPaused = true;
  }
});

const wasPaused = !!window.__honouaHistoryPaused;
window.__honouaHistoryPaused = true;

try {
  // … tes opérations bruyantes (ajout EANs, multiples updates, etc.)
} finally {
  window.__honouaHistoryPaused = wasPaused; // restaure l’état précédent
}

</script>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- A15 — Hook de résolution carbone (override) -->
<script>
/**
 * Définis ici comment récupérer l’empreinte d’un EAN (gCO2e).
 * Retourne un nombre (gCO2e) ou null si inconnu.
 * Tu peux remplacer l’exemple MAP par un fetch API.
 */
window.honouaCarbonLookup = async function(ean){
  // Exemple simple (mapping local) — à remplacer par ton API
  const MAP = {
    "3274080005003": 120,  // ex.
    "3017620429484": 450   // ex.
  };
  return MAP[ean] ?? null;
};
</script>

<script>
window.honouaCarbonLookup = async function(ean){
  const res = await fetch('/api/honoua/emissions?ean=' + encodeURIComponent(ean));
  if (!res.ok) return null;
  const obj = await res.json();
  // Attendu : { ean: "xxx", gco2e: 123.4 }
  return (typeof obj.gco2e === 'number') ? obj.gco2e : null;
};
</script>





<script>
/* ============================================================================
   A14 — Statistiques et graphiques d'utilisation
   ============================================================================ */
(function(){
  var HISTORY_KEY = 'honoua_compare_history_v1';
  var $section, $chart, $total, $week, $pinned, $avg;
  var chartInstance = null;

  function readHistory(){
    try { return JSON.parse(localStorage.getItem(HISTORY_KEY)) || []; }
    catch { return []; }
  }

  // Calcule les stats de base
  function computeStats(list){
    var now = Date.now();
    var weekAgo = now - 7*24*60*60*1000;
    var total = list.length;
    var pinned = list.filter(e => e.pinned).length;
    var week = list.filter(e => new Date(e.ts).getTime() >= weekAgo).length;
    var avgProducts = 0;
    if (total > 0) {
      avgProducts = list.reduce((sum, e) => sum + (e.productCount || 0), 0) / total;
      avgProducts = avgProducts.toFixed(1);
    }
    return { total, pinned, week, avgProducts };
  }

  // Prépare les données pour le graphique (sessions/jour)
  function groupByDay(list){
    var map = {};
    list.forEach(e => {
      var d = new Date(e.ts);
      var key = d.toISOString().slice(0,10);
      map[key] = (map[key] || 0) + 1;
    });
    var keys = Object.keys(map).sort();
    return {
      labels: keys,
      data: keys.map(k => map[k])
    };
  }

  function renderChart(list){
    var ctx = $chart.getContext('2d');
    var g = groupByDay(list);
    if (chartInstance) chartInstance.destroy();
    chartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: g.labels,
        datasets: [{
          label: 'Sessions par jour',
          data: g.data,
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false }
        },
        scales: {
          x: { ticks: { color: '#333' } },
          y: { beginAtZero: true, ticks: { stepSize: 1, color: '#333' } }
        }
      }
    });
  }

  function renderStats(){
    var list = readHistory();
    if (!list.length) { $section.hidden = true; return; }
    var s = computeStats(list);
    $section.hidden = false;
    $total.textContent = s.total;
    $pinned.textContent = s.pinned;
    $week.textContent = s.week;
    $avg.textContent = s.avgProducts;
    renderChart(list);
  }

  document.addEventListener('DOMContentLoaded', function(){
    $section = document.getElementById('compare-stats');
    $chart   = document.getElementById('stat-chart');
    $total   = document.getElementById('stat-total');
    $week    = document.getElementById('stat-week');
    $pinned  = document.getElementById('stat-pinned');
    $avg     = document.getElementById('stat-avg');

    if (!$section || !$chart) return;
    renderStats();

    // Mettre à jour en live quand l’historique change
    window.addEventListener('storage', function(e){
      if (e.key === HISTORY_KEY) renderStats();
    });
    window.addEventListener('honoua:compare:updated', renderStats);
  });
})();
</script>

<script>
/* ============================================================================
   A15 — Évolution carbone (moyenne/somme par session, regroupée par jour)
   - Hook extensible: window.honouaCarbonLookup(ean) -> Promise<number|null> en gCO2e
   - Cache local pour accélérer: honoua_carbon_cache_v1
   ============================================================================ */
(function(){
  var HISTORY_KEY = 'honoua_compare_history_v1';
  var CARBON_CACHE_KEY = 'honoua_carbon_cache_v1';

  var $section, $chart, $sessions, $globalAvg, $modeSel;
  var chartInstance = null;

  // ---------- Hook de résolution d'émissions par EAN ----------
  // Surchargable par l'app : window.honouaCarbonLookup = async (ean) => number|null
  if (typeof window.honouaCarbonLookup !== 'function') {
    // Stub : renvoie null (inconnu). À remplacer par ta logique.
    window.honouaCarbonLookup = async function(ean){
      // Exemple (à adapter) :
      // return await fetch('/api/emissions?ean='+encodeURIComponent(ean)).then(r=>r.json()).then(o=>o.gco2e ?? null);
      return null;
    };
  }

  // ---------- Cache simple localStorage ----------
  function readCarbonCache(){
    try { return JSON.parse(localStorage.getItem(CARBON_CACHE_KEY)) || {}; }
    catch { return {}; }
  }
  function writeCarbonCache(obj){
    try { localStorage.setItem(CARBON_CACHE_KEY, JSON.stringify(obj)); }
    catch(e){ console.warn('[A15] writeCarbonCache:', e); }
  }

  async function carbonForEAN(ean) {
    if (!ean) return null;
    var cache = readCarbonCache();
    if (Object.prototype.hasOwnProperty.call(cache, ean)) {
      return cache[ean]; // peut être number ou null (inconnu)
    }
    // lookup via hook
    var val = null;
    try { val = await window.honouaCarbonLookup(String(ean)); }
    catch(e){ console.warn('[A15] Lookup error for EAN', ean, e); val = null; }
    cache[ean] = (typeof val === 'number' && isFinite(val)) ? val : null;
    writeCarbonCache(cache);
    return cache[ean];
  }

  // Calcule les émissions d'une session (avg ou sum) sur les EANs connus
  async function computeSessionMetric(entry, mode){
    var eans = (entry && entry.params && Array.isArray(entry.params.eans)) ? entry.params.eans : [];
    if (!eans.length) return null;
    var vals = await Promise.all(eans.map(carbonForEAN));
    var known = vals.filter(v => typeof v === 'number' && isFinite(v));
    if (!known.length) return null;
    var sum = known.reduce((a,b)=>a+b, 0);
    if (mode === 'sum_per_session') return sum;
    // default: avg per session (gCO2e/session)
    return sum / known.length;
  }

  // Agrège par jour: { 'YYYY-MM-DD': [metrics...] }
  function groupByDay(values){
    var map = {};
    values.forEach(v => {
      var day = v.day;
      if (!map[day]) map[day] = [];
      map[day].push(v.value);
    });
    var labels = Object.keys(map).sort();
    var data = labels.map(d => {
      var arr = map[d];
      var avg = arr.reduce((a,b)=>a+b,0)/arr.length;
      return Math.round(avg); // arrondi propre pour l'affichage
    });
    return { labels, data, countsByDay: map };
  }

  function renderChart(series, mode){
    var ctx = $chart.getContext('2d');
    if (chartInstance) chartInstance.destroy();
    chartInstance = new Chart(ctx, {
      type: 'line',
      data: {
        labels: series.labels,
        datasets: [{
          label: (mode === 'sum_per_session' ? 'Total par session (gCO₂e)' : 'Moyenne par session (gCO₂e)'),
          data: series.data,
          borderWidth: 2,
          tension: 0.25,
          pointRadius: 2
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { color: '#333' } },
          y: { beginAtZero: true, ticks: { color: '#333' } }
        }
      }
    });
  }

  async function renderCarbon(){
    var history = [];
    try { history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || []; }
    catch{ history = []; }

    if (!history.length) { $section.hidden = true; return; }
    var mode = $modeSel?.value || 'avg_per_session';

    // Calcule métrique par session (async, respect du cache)
    // On limite prudemment à 200 sessions pour éviter un premier rendu trop long.
    var slice = history.slice(-200); 
    // Convertit en [{day:'YYYY-MM-DD', value:number}, ...] en série
    var points = [];
    for (let i=0; i<slice.length; i++){
      var e = slice[i];
      var v = await computeSessionMetric(e, mode);
      if (v == null) continue; // on ignore les sessions sans émission connue
      var day = new Date(e.ts).toISOString().slice(0,10);
      points.push({ day, value: v });
    }

    if (!points.length) {
      // rien d'exploitable (pas d'émissions connues) -> on masque
      $section.hidden = true;
      return;
    }

    var grouped = groupByDay(points);
    $section.hidden = false;
    // sessions comptabilisées = nb de sessions avec au moins 1 émission connue (dans le slice)
    document.getElementById('carbon-sessions').textContent = String(points.length);

    // moyenne globale des points (moyennes journalières déjà calculées)
    var globalAvg = 0;
    if (grouped.data.length) {
      globalAvg = Math.round(grouped.data.reduce((a,b)=>a+b,0) / grouped.data.length);
    }
    document.getElementById('carbon-global-avg').textContent = String(globalAvg);

    renderChart(grouped, mode);
  }

  document.addEventListener('DOMContentLoaded', function(){
    $section   = document.getElementById('compare-carbon');
    $chart     = document.getElementById('carbon-chart');
    $sessions  = document.getElementById('carbon-sessions');
    $globalAvg = document.getElementById('carbon-global-avg');
    $modeSel   = document.getElementById('carbon-mode');

    if (!$section || !$chart) return;

    // premier rendu
    renderCarbon();

    // re-rendu: changements d'historique, mise à jour compare, changement de mode
    window.addEventListener('storage', function(e){ if (e.key === HISTORY_KEY || e.key === CARBON_CACHE_KEY) renderCarbon(); });
    window.addEventListener('honoua:compare:updated', renderCarbon);
    if ($modeSel) $modeSel.addEventListener('change', renderCarbon);
  });
})();
</script>

<script>
/* A15.bis — Purge du cache carbone */
(function(){
  var CARBON_CACHE_KEY = 'honoua_carbon_cache_v1';
  document.addEventListener('DOMContentLoaded', function(){
    var btn = document.getElementById('carbon-cache-clear');
    if (!btn) return;
    btn.addEventListener('click', function(){
      try {
        localStorage.removeItem(CARBON_CACHE_KEY);
        // Notifie les listeners (A14/A15 écoutent 'storage')
        window.dispatchEvent(new StorageEvent('storage', { key: CARBON_CACHE_KEY }));
        alert('Cache carbone purgé ✅');
      } catch(e){
        console.warn('[A15.bis] Purge cache carbone échouée:', e);
        alert('Impossible de purger le cache carbone ❌');
      }
    });
  });
})();
</script>

<script>
/* ============================================================================
   A16 — Export CSV des séries (stats et carbone)
   ============================================================================ */
(function(){
  const HISTORY_KEY = 'honoua_compare_history_v1';
  const CARBON_CACHE_KEY = 'honoua_carbon_cache_v1';

  // Utilitaires CSV
  function downloadCSV(filename, rows) {
    const processRow = (row) => row.map(v => `"${(v ?? '').toString().replace(/"/g, '""')}"`).join(',');
    const csv = rows.map(processRow).join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  function groupSessionsByDay(list){
    const map = {};
    list.forEach(e => {
      const d = new Date(e.ts).toISOString().slice(0,10);
      map[d] = (map[d] || 0) + 1;
    });
    return Object.entries(map).map(([day, count]) => [day, count]);
  }

  async function exportStatsCSV(){
    let history = [];
    try { history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || []; } catch {}
    if (!history.length) return alert("Aucune donnée à exporter.");
    const grouped = groupSessionsByDay(history);
    const rows = [["Date", "Nombre de sessions"], ...grouped];
    downloadCSV("sessions_par_jour.csv", rows);
  }

  async function exportCarbonCSV(){
    if (typeof window.honouaCarbonLookup !== "function") {
      return alert("Le module carbone (A15) n’est pas actif.");
    }
    let history = [];
    try { history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || []; } catch {}
    if (!history.length) return alert("Aucune donnée carbone.");
    const cache = JSON.parse(localStorage.getItem(CARBON_CACHE_KEY) || "{}");
    const dayMap = {};
    for (const e of history) {
      const eans = (e.params?.eans) || [];
      const day = new Date(e.ts).toISOString().slice(0,10);
      const vals = eans.map(x => cache[x]).filter(v => typeof v === "number");
      if (!vals.length) continue;
      const avg = vals.reduce((a,b)=>a+b,0) / vals.length;
      if (!dayMap[day]) dayMap[day] = [];
      dayMap[day].push(avg);
    }
    const rows = [["Date", "Moyenne gCO2e/session"]];
    for (const day of Object.keys(dayMap).sort()) {
      const arr = dayMap[day];
      const mean = arr.reduce((a,b)=>a+b,0)/arr.length;
      rows.push([day, mean.toFixed(1)]);
    }
    downloadCSV("carbone_journalier.csv", rows);
  }

  document.addEventListener("DOMContentLoaded", () => {
    const btnStats = document.getElementById("export-stats-csv");
    const btnCarbon = document.getElementById("export-carbon-csv");
    if (btnStats) btnStats.addEventListener("click", exportStatsCSV);
    if (btnCarbon) btnCarbon.addEventListener("click", exportCarbonCSV);
  });
})();
</script>




</body>
</html>
